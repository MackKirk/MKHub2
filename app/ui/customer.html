<!doctype html>
<meta charset="utf-8">
<title>Customer</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<script src="/ui/geo.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>Customer</h2>
  <div id="info" class="card"></div>

  <div class="card">
    <h3>Details</h3>
    <div class="row">
      <div class="field"><label>Display name *</label><input id="display_name" /></div>
      <div class="field"><label>Legal name</label><input id="legal_name" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Code</label><input id="code" /></div>
      <div class="field"><label>Type</label><input id="client_type" /></div>
      <div class="field"><label>Status</label><input id="client_status" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Lead source</label><input id="lead_source" /></div>
      <div class="field"><label>Billing email</label><input id="billing_email" /></div>
      <div class="field"><label>PO required</label><select id="po_required"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <div class="row"><div class="field"><label>Tax number</label><input id="tax_number" /></div></div>
    <div class="row"><div class="field" style="flex:1"><label>Description</label><input id="description" /></div></div>
    <h4>Address</h4>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="postal_code" /></div>
    </div>
    <h4>Billing Address</h4>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="billing_address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="billing_address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="billing_country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="billing_province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="billing_city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="billing_postal_code" /></div>
    </div>
    <div class="row">
      <button id="save">Save</button>
      <a class="btn" href="/ui/customers.html">Back</a>
    </div>
    <pre id="msg" class="muted"></pre>
  </div>

  <div class="card">
    <h3>Files</h3>
    <div class="row">
      <input type="file" id="file" />
      <button id="upload">Upload</button>
    </div>
    <div id="filesList" class="card"></div>
  </div>

  <div class="card">
    <h3>Communication Preferences</h3>
    <div class="row">
      <div class="field"><label>Language</label><input id="preferred_language" /></div>
      <div class="field"><label>Preferred channels (comma-separated)</label><input id="preferred_channels" placeholder="Email, Phone, SMS"/></div>
    </div>
    <div class="row">
      <div class="field"><label>Marketing opt-in</label><select id="marketing_opt_in"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field"><label>Invoice delivery</label><input id="invoice_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
      <div class="field"><label>Statement delivery</label><input id="statement_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for invoices (comma-separated)</label><input id="cc_emails_for_invoices" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for estimates (comma-separated)</label><input id="cc_emails_for_estimates" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Do not contact</label><select id="do_not_contact"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field" style="flex:1"><label>Reason</label><input id="do_not_contact_reason" /></div>
    </div>
  </div>

  <div class="card">
    <h3>Contacts</h3>
    <div id="contactsList" class="card"></div>
    <h4>Add Contact</h4>
    <div class="row">
      <div class="field"><label>Name</label><input id="c_name" /></div>
      <div class="field"><label>Email</label><input id="c_email" /></div>
      <div class="field"><label>Phone</label><input id="c_phone" /></div>
      <div class="field"><label>Primary</label><select id="c_primary"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <button id="addContact">Add Contact</button>
  </div>
</div>
<script>
MKHubUI.initSidebar('customers');
const params = new URLSearchParams(location.search);
const id = params.get('id');
function auth(){ return { Authorization:'Bearer '+MKHubUI.getTokenOrRedirect() }; }
async function load(){
  const r = await fetch('/clients/'+id, { headers: auth() });
  const info = document.getElementById('info');
  if (!r.ok){ info.textContent='Not authorized or not found.'; return; }
  const c = await r.json();
  info.innerHTML = `<strong>${c.display_name || c.name}</strong>${c.code?` <span class=muted>(${c.code})</span>`:''}` +
    `${c.city||c.province||c.country?`<div class=muted>${[c.city,c.province,c.country].filter(Boolean).join(', ')}</div>`:''}`;
  const set=(k,v)=>{ const el=document.getElementById(k); if (el) el.value=v||''; };
  for (const k of ['display_name','legal_name','code','client_type','client_status','lead_source','description','billing_email','tax_number','address_line1','address_line2','country','province','city','postal_code','billing_address_line1','billing_address_line2','billing_country','billing_province','billing_city','billing_postal_code','preferred_language','invoice_delivery_method','statement_delivery_method','do_not_contact_reason']){ set(k, c[k]); }
  // Multi-value fields
  const arrOr = (v)=> Array.isArray(v) ? v : (v ? [v] : []);
  document.getElementById('preferred_channels').value = (arrOr(c.preferred_channels)||[]).join(', ');
  document.getElementById('cc_emails_for_invoices').value = (arrOr(c.cc_emails_for_invoices)||[]).join(', ');
  document.getElementById('cc_emails_for_estimates').value = (arrOr(c.cc_emails_for_estimates)||[]).join(', ');
  document.getElementById('marketing_opt_in').value = c.marketing_opt_in ? 'true':'false';
  document.getElementById('do_not_contact').value = c.do_not_contact ? 'true':'false';
  document.getElementById('po_required').value = c.po_required ? 'true':'false';
  await loadContacts();
}
async function save(){
  const body = {};
  for (const k of ['display_name','legal_name','code','client_type','client_status','lead_source','description','billing_email','tax_number','address_line1','address_line2','country','province','city','postal_code','billing_address_line1','billing_address_line2','billing_country','billing_province','billing_city','billing_postal_code','preferred_language','invoice_delivery_method','statement_delivery_method','do_not_contact_reason']){ body[k] = document.getElementById(k).value || null; }
  // Multi-value
  const splitCsv = (id)=> (document.getElementById(id).value||'').split(',').map(s=>s.trim()).filter(Boolean);
  body['preferred_channels'] = splitCsv('preferred_channels');
  body['cc_emails_for_invoices'] = splitCsv('cc_emails_for_invoices');
  body['cc_emails_for_estimates'] = splitCsv('cc_emails_for_estimates');
  body['marketing_opt_in'] = document.getElementById('marketing_opt_in').value === 'true';
  body['do_not_contact'] = document.getElementById('do_not_contact').value === 'true';
  body['po_required'] = document.getElementById('po_required').value === 'true';
  const r = await fetch('/clients/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  document.getElementById('msg').textContent = await r.text();
  await load();
}
async function loadContacts(){
  const arr = await fetch('/clients/'+id, { headers: auth() }).then(x=>x.json()); // no dedicated list; reuse detail
  // There's no contacts list in detail response; call a future endpoint if added.
}
async function addContact(){
  const body = { name: document.getElementById('c_name').value || null, email: document.getElementById('c_email').value || null, phone: document.getElementById('c_phone').value || null, is_primary: document.getElementById('c_primary').value==='true' };
  const r = await fetch('/clients/'+id+'/contacts', { method:'POST', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  if (r.ok){ document.getElementById('c_name').value=''; document.getElementById('c_email').value=''; document.getElementById('c_phone').value=''; loadContacts(); }
}
document.getElementById('save').addEventListener('click', save);
document.getElementById('addContact').addEventListener('click', addContact);

// File uploads linked to client via category key
document.getElementById('upload').addEventListener('click', async ()=>{
  const f = document.getElementById('file').files[0]; if (!f) return;
  const token = MKHubUI.getTokenOrRedirect();
  const upReq = { project_id: null, client_id: id, employee_id: null, category_id: 'client-docs', original_name: f.name, content_type: f.type || 'application/octet-stream' };
  const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
  const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
  if (!putResp.ok) return;
  const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na' }) }).then(x=>x.json());
  // Attach file to customer
  await fetch(`/clients/${id}/files?file_object_id=${encodeURIComponent(conf.id)}&category=client-docs&original_name=${encodeURIComponent(f.name)}`, { method:'POST', headers:{ Authorization:'Bearer '+token } });
  await loadFiles();
});

async function loadFiles(){
  const token = MKHubUI.getTokenOrRedirect();
  const arr = await fetch(`/clients/${id}/files`, { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
  const el = document.getElementById('filesList');
  if (!Array.isArray(arr) || !arr.length){ el.textContent = 'No files'; return; }
  el.innerHTML = arr.map(f=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0">`
    + `<div>${f.original_name||f.key||f.file_object_id} <span class=muted>${(f.uploaded_at||'').slice(0,19).replace('T',' ')}</span></div>`
    + `<div><button onclick="downloadFile('${f.file_object_id}')">Download</button></div>`
  + `</div>`).join('');
}
async function downloadFile(fid){ try{ const j=await fetch('/files/'+fid+'/download').then(x=>x.json()); if (j && j.download_url){ window.open(j.download_url, '_blank'); } }catch(e){} }

// Geo dropdowns
(async function initGeo(){
  await (window.MKHubGeo && window.MKHubGeo.load ? window.MKHubGeo.load() : Promise.resolve());
  const countrySel = document.getElementById('country');
  const stateSel = document.getElementById('province');
  const citySel = document.getElementById('city');
  const countries = (window.MKHubGeo && window.MKHubGeo.data) || [];
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; countrySel.appendChild(o); }
  async function populateStates(country){ stateSel.innerHTML='<option value="">Select...</option>'; citySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); } }
  async function populateCities(country,state){ citySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; citySel.appendChild(o); } }
  countrySel.addEventListener('change', e=>populateStates(e.target.value));
  stateSel.addEventListener('change', ()=>populateCities(countrySel.value, stateSel.value));
})();

load();
// Also load files initially
loadFiles();
</script>


