<!doctype html>
<meta charset="utf-8">
<title>Customer</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<script src="/ui/geo.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>Customer</h2>
  <div class="tabs">
    <a id="tab-details" href="#" class="active" onclick="showTab(event,'details')">Details</a>
    <a id="tab-addresses" href="#" onclick="showTab(event,'addresses')">Addresses</a>
    <a id="tab-comms" href="#" onclick="showTab(event,'comms')">Communication</a>
    <a id="tab-files" href="#" onclick="showTab(event,'files')">Files</a>
    <a id="tab-contacts" href="#" onclick="showTab(event,'contacts')">Contacts</a>
    <a id="tab-sites" href="#" onclick="showTab(event,'sites')">Sites</a>
  </div>
  <div id="info" class="card"></div>

  <div id="details" class="card" style="display:block">
    <h3>Details</h3>
    <div class="row">
      <div class="field"><label>Display name *</label><input id="display_name" /></div>
      <div class="field"><label>Legal name</label><input id="legal_name" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Code</label><input id="code" readonly /></div>
      <div class="field"><label>Type</label><select id="client_type"><option value="">Select...</option></select></div>
      <div class="field"><label>Status</label><select id="client_status"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>Lead source</label><input id="lead_source" /></div>
      <div class="field"><label>Billing email</label><input id="billing_email" /></div>
      <div class="field"><label>PO required</label><select id="po_required"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <div class="row"><div class="field"><label>Tax number</label><input id="tax_number" /></div></div>
    <div class="row"><div class="field" style="flex:1"><label>Description</label><input id="description" /></div></div>
    <div class="row">
      <button id="save">Save</button>
      <a class="btn" href="/ui/customers.html">Back</a>
    </div>
    <pre id="msg" class="muted"></pre>
  </div>

  <div id="addresses" class="card" style="display:none">
    <h3>Address</h3>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="postal_code" /></div>
    </div>
    <h4>Billing Address</h4>
    <div class="row">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="billing_same"> Billing address is the same as Address</label>
    </div>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="billing_address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="billing_address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="billing_country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="billing_province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="billing_city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="billing_postal_code" /></div>
    </div>
  </div>

  <div id="files" class="card" style="display:none">
    <h3>Files</h3>
    <div class="row">
      <input type="file" id="file" />
      <button id="upload">Upload</button>
    </div>
    <div id="filesList" class="card"></div>
  </div>

  <div id="comms" class="card" style="display:none">
    <h3>Communication Preferences</h3>
    <div class="row">
      <div class="field"><label>Language</label><input id="preferred_language" /></div>
      <div class="field"><label>Preferred channels (comma-separated)</label><input id="preferred_channels" placeholder="Email, Phone, SMS"/></div>
    </div>
    <div class="row">
      <div class="field"><label>Marketing opt-in</label><select id="marketing_opt_in"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field"><label>Invoice delivery</label><input id="invoice_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
      <div class="field"><label>Statement delivery</label><input id="statement_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for invoices (comma-separated)</label><input id="cc_emails_for_invoices" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for estimates (comma-separated)</label><input id="cc_emails_for_estimates" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Do not contact</label><select id="do_not_contact"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field" style="flex:1"><label>Reason</label><input id="do_not_contact_reason" /></div>
    </div>
  </div>

  <div id="contacts" class="card" style="display:none">
    <h3>Contacts</h3>
    <div id="contactsList" class="card"></div>
    <h4>Add Contact</h4>
    <div class="row">
      <div class="field"><label>Name</label><input id="c_name" /></div>
      <div class="field"><label>Email</label><input id="c_email" /></div>
      <div class="field"><label>Phone</label><input id="c_phone" /></div>
      <div class="field"><label>Primary</label><select id="c_primary"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <button id="addContact">Add Contact</button>
  </div>

  <div id="sites" class="card" style="display:none">
    <h3>Sites</h3>
    <div id="sitesList" class="card"></div>
    <h4>Add Site</h4>
    <div class="row">
      <div class="field"><label>Name</label><input id="s_name" /></div>
      <div class="field"><label>Address 1</label><input id="s_address1" /></div>
      <div class="field"><label>Address 2</label><input id="s_address2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><input id="s_city" /></div>
      <div class="field"><label>Province/State</label><input id="s_province" /></div>
      <div class="field"><label>Postal/Zip</label><input id="s_postal" /></div>
      <div class="field"><label>Country</label><input id="s_country" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>Notes</label><input id="s_notes" /></div>
    </div>
    <button id="addSite">Add Site</button>
  </div>
</div>
<script>
MKHubUI.initSidebar('customers');
const params = new URLSearchParams(location.search);
const id = params.get('id');
function auth(){ return { Authorization:'Bearer '+MKHubUI.getTokenOrRedirect() }; }
function showTab(ev, which){ ev && ev.preventDefault(); const tabs=['details','addresses','comms','files','contacts','sites']; for (const k of tabs){ const el=document.getElementById(k); if (el) el.style.display = (k===which) ? 'block':'none'; } for (const k of tabs){ const t=document.getElementById('tab-'+k); if (t){ if (k===which) t.classList.add('active'); else t.classList.remove('active'); } } if (which==='contacts'){ loadContacts(); } if (which==='files'){ loadFiles(); } if (which==='sites'){ loadSites(); } }
async function load(){
  const r = await fetch('/clients/'+id, { headers: auth() });
  const info = document.getElementById('info');
  if (!r.ok){ info.textContent='Not authorized or not found.'; return; }
  const c = await r.json();
  info.innerHTML = `<strong>${c.display_name || c.name}</strong>${c.code?` <span class=muted>(${c.code})</span>`:''}` +
    `${c.city||c.province||c.country?`<div class=muted>${[c.city,c.province,c.country].filter(Boolean).join(', ')}</div>`:''}`;
  const set=(k,v)=>{ const el=document.getElementById(k); if (el) el.value=v||''; };
  // Set simple inputs first
  for (const k of ['display_name','legal_name','code','lead_source','description','billing_email','tax_number','address_line1','address_line2','postal_code','billing_address_line1','billing_address_line2','billing_postal_code','preferred_language','invoice_delivery_method','statement_delivery_method','do_not_contact_reason']){ set(k, c[k]); }
  // Ensure dropdown options are ready then set them
  await ensureSettingsLoaded();
  set('client_type', c.client_type);
  set('client_status', c.client_status);
  await ensureGeoReady();
  await setAddressSelects('country','province','city', c.country, c.province, c.city);
  await setAddressSelects('billing_country','billing_province','billing_city', c.billing_country, c.billing_province, c.billing_city);
  // Multi-value fields
  const arrOr = (v)=> Array.isArray(v) ? v : (v ? [v] : []);
  document.getElementById('preferred_channels').value = (arrOr(c.preferred_channels)||[]).join(', ');
  document.getElementById('cc_emails_for_invoices').value = (arrOr(c.cc_emails_for_invoices)||[]).join(', ');
  document.getElementById('cc_emails_for_estimates').value = (arrOr(c.cc_emails_for_estimates)||[]).join(', ');
  document.getElementById('marketing_opt_in').value = c.marketing_opt_in ? 'true':'false';
  document.getElementById('do_not_contact').value = c.do_not_contact ? 'true':'false';
  document.getElementById('po_required').value = c.po_required ? 'true':'false';
}
// Load settings for dropdowns
(async function initSettings(){
  try{
    const token = MKHubUI.getTokenOrRedirect();
    const s = await fetch('/settings', { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
    const types = s.client_types || [];
    const statuses = s.client_statuses || [];
    const typeSel = document.getElementById('client_type');
    const statusSel = document.getElementById('client_status');
    for (const it of types){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; typeSel.appendChild(o); }
    for (const it of statuses){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; statusSel.appendChild(o); }
    window.__settingsLoaded = true;
  }catch(e){}
})();
async function save(){
  const body = {};
  for (const k of ['display_name','legal_name','code','client_type','client_status','lead_source','description','billing_email','tax_number','address_line1','address_line2','country','province','city','postal_code','billing_address_line1','billing_address_line2','billing_country','billing_province','billing_city','billing_postal_code','preferred_language','invoice_delivery_method','statement_delivery_method','do_not_contact_reason']){ body[k] = document.getElementById(k).value || null; }
  // Multi-value
  const splitCsv = (id)=> (document.getElementById(id).value||'').split(',').map(s=>s.trim()).filter(Boolean);
  body['preferred_channels'] = splitCsv('preferred_channels');
  body['cc_emails_for_invoices'] = splitCsv('cc_emails_for_invoices');
  body['cc_emails_for_estimates'] = splitCsv('cc_emails_for_estimates');
  body['marketing_opt_in'] = document.getElementById('marketing_opt_in').value === 'true';
  body['do_not_contact'] = document.getElementById('do_not_contact').value === 'true';
  body['po_required'] = document.getElementById('po_required').value === 'true';
  const r = await fetch('/clients/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  document.getElementById('msg').textContent = await r.text();
  await load();
}
async function loadContacts(){
  try{
    const arr = await fetch('/clients/'+id+'/contacts', { headers: auth() }).then(x=>x.json());
    const el = document.getElementById('contactsList');
    el.innerHTML = (arr||[]).map(c=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0">`
      + `<div>${c.name||''} ${c.email?`<span class=muted>${c.email}</span>`:''} ${c.phone?`<span class=muted>${c.phone}</span>`:''} ${c.is_primary?`<span class=muted>[primary]</span>`:''}</div>`
      + `<div><button onclick=\"delContact('${c.id}')\">Delete</button></div>`
    + `</div>`).join('') || 'No contacts';
  }catch(e){}
}
async function addContact(){
  const body = { name: document.getElementById('c_name').value || null, email: document.getElementById('c_email').value || null, phone: document.getElementById('c_phone').value || null, is_primary: document.getElementById('c_primary').value==='true' };
  const r = await fetch('/clients/'+id+'/contacts', { method:'POST', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  if (r.ok){ document.getElementById('c_name').value=''; document.getElementById('c_email').value=''; document.getElementById('c_phone').value=''; loadContacts(); }
}
async function delContact(cid){ try{ await fetch('/clients/'+id+'/contacts/'+cid, { method:'DELETE', headers: auth() }); loadContacts(); }catch(e){}
}

// Sites
async function loadSites(){
  try{
    const arr = await fetch('/clients/'+id+'/sites', { headers: auth() }).then(x=>x.json());
    const el = document.getElementById('sitesList');
    el.innerHTML = (arr||[]).map(s=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0">`
      + `<div><strong>${s.site_name||''}</strong>${s.site_address_line1?` — ${s.site_address_line1}`:''} ${s.site_city||''} ${s.site_province||''} ${s.site_country||''}</div>`
      + `<div><button onclick=\"delSite('${s.id}')\">Delete</button></div>`
    + `</div>`).join('') || 'No sites';
  }catch(e){}
}
async function addSite(){
  const payload = {
    site_name: document.getElementById('s_name').value || null,
    site_address_line1: document.getElementById('s_address1').value || null,
    site_address_line2: document.getElementById('s_address2').value || null,
    site_city: document.getElementById('s_city').value || null,
    site_province: document.getElementById('s_province').value || null,
    site_postal_code: document.getElementById('s_postal').value || null,
    site_country: document.getElementById('s_country').value || null,
    site_notes: document.getElementById('s_notes').value || null,
  };
  const r = await fetch('/clients/'+id+'/sites', { method:'POST', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(payload) });
  if (r.ok){ document.getElementById('s_name').value=''; document.getElementById('s_address1').value=''; document.getElementById('s_address2').value=''; document.getElementById('s_city').value=''; document.getElementById('s_province').value=''; document.getElementById('s_postal').value=''; document.getElementById('s_country').value=''; document.getElementById('s_notes').value=''; loadSites(); }
}
async function delSite(sid){ try{ await fetch('/clients/'+id+'/sites/'+sid, { method:'DELETE', headers: auth() }); loadSites(); }catch(e){}
}

document.getElementById('save').addEventListener('click', save);
document.getElementById('addContact').addEventListener('click', addContact);
document.getElementById('addSite').addEventListener('click', addSite);

// File uploads linked to client via category key
document.getElementById('upload').addEventListener('click', async ()=>{
  const f = document.getElementById('file').files[0]; if (!f) return;
  const token = MKHubUI.getTokenOrRedirect();
  const upReq = { project_id: null, client_id: id, employee_id: null, category_id: 'client-docs', original_name: f.name, content_type: f.type || 'application/octet-stream' };
  const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
  const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
  if (!putResp.ok) return;
  const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na' }) }).then(x=>x.json());
  // Attach file to customer
  await fetch(`/clients/${id}/files?file_object_id=${encodeURIComponent(conf.id)}&category=client-docs&original_name=${encodeURIComponent(f.name)}`, { method:'POST', headers:{ Authorization:'Bearer '+token } });
  await loadFiles();
});

async function loadFiles(){
  const token = MKHubUI.getTokenOrRedirect();
  const arr = await fetch(`/clients/${id}/files`, { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
  const el = document.getElementById('filesList');
  if (!Array.isArray(arr) || !arr.length){ el.textContent = 'No files'; return; }
  el.innerHTML = arr.map(f=>`<div style=\"display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0\">`
    + `<div>${f.original_name||f.key||f.file_object_id} <span class=muted>${(f.uploaded_at||'').slice(0,19).replace('T',' ')}</span></div>`
    + `<div><button onclick=\"downloadFile('${f.file_object_id}')\">Download</button></div>`
  + `</div>`).join('');
}
async function downloadFile(fid){ try{ const j=await fetch('/files/'+fid+'/download').then(x=>x.json()); if (j && j.download_url){ window.open(j.download_url, '_blank'); } }catch(e){} }

// Geo dropdowns
(async function initGeo(){
  await (window.MKHubGeo && window.MKHubGeo.load ? window.MKHubGeo.load() : Promise.resolve());
  const countrySel = document.getElementById('country');
  const stateSel = document.getElementById('province');
  const citySel = document.getElementById('city');
  const bCountrySel = document.getElementById('billing_country');
  const bStateSel = document.getElementById('billing_province');
  const bCitySel = document.getElementById('billing_city');
  const countries = (window.MKHubGeo && window.MKHubGeo.data) || [];
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; countrySel.appendChild(o); }
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; bCountrySel.appendChild(o); }
  async function populateStates(country){ stateSel.innerHTML='<option value="">Select...</option>'; citySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); } }
  async function populateCities(country,state){ citySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; citySel.appendChild(o); } }
  async function bPopulateStates(country){ bStateSel.innerHTML='<option value="">Select...</option>'; bCitySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; bStateSel.appendChild(o); } }
  async function bPopulateCities(country,state){ bCitySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; bCitySel.appendChild(o); } }
  countrySel.addEventListener('change', e=>populateStates(e.target.value));
  stateSel.addEventListener('change', ()=>populateCities(countrySel.value, stateSel.value));
  bCountrySel.addEventListener('change', e=>bPopulateStates(e.target.value));
  bStateSel.addEventListener('change', ()=>bPopulateCities(bCountrySel.value, bStateSel.value));
  window.__MKGeo = { populateStates, populateCities, bPopulateStates, bPopulateCities, countrySel, stateSel, citySel, bCountrySel, bStateSel, bCitySel };
})();

// Billing same-as Address handling
function setBillingDisabled(disabled){
  const ids=['billing_address_line1','billing_address_line2','billing_country','billing_province','billing_city','billing_postal_code'];
  for (const id of ids){ const el=document.getElementById(id); if (el) el.disabled = !!disabled; }
}
async function syncBillingFromAddress(){
  const h=window.__MKGeo || {};
  const { countrySel, stateSel, citySel, bCountrySel } = h;
  document.getElementById('billing_address_line1').value = document.getElementById('address_line1').value || '';
  document.getElementById('billing_address_line2').value = document.getElementById('address_line2').value || '';
  document.getElementById('billing_postal_code').value = document.getElementById('postal_code').value || '';
  if (countrySel && bCountrySel){
    const c = countrySel.value || '';
    bCountrySel.value = c;
    if (h.bPopulateStates){ await h.bPopulateStates(c); }
    const p = (h.stateSel && h.stateSel.value) || '';
    const bStateSel = h.bStateSel; const bCitySel = h.bCitySel;
    if (bStateSel){ bStateSel.value = p; }
    if (h.bPopulateCities){ await h.bPopulateCities(c, p); }
    const city = (h.citySel && h.citySel.value) || '';
    if (bCitySel){ bCitySel.value = city; }
  }
}
const billingSameEl = document.getElementById('billing_same');
if (billingSameEl){
  billingSameEl.addEventListener('change', async ()=>{ if (billingSameEl.checked){ await syncBillingFromAddress(); setBillingDisabled(true); } else { setBillingDisabled(false); } });
  const addrIds=['address_line1','address_line2','postal_code'];
  for (const id of addrIds){ const el=document.getElementById(id); if (el){ el.addEventListener('input', ()=>{ if (billingSameEl.checked) syncBillingFromAddress(); }); } }
  document.getElementById('country').addEventListener('change', ()=>{ if (billingSameEl.checked) syncBillingFromAddress(); });
  document.getElementById('province').addEventListener('change', ()=>{ if (billingSameEl.checked) syncBillingFromAddress(); });
  document.getElementById('city').addEventListener('change', ()=>{ if (billingSameEl.checked) syncBillingFromAddress(); });
}

// Helpers to ensure async option lists are ready
async function ensureSettingsLoaded(){
  const typeSel = document.getElementById('client_type');
  const statusSel = document.getElementById('client_status');
  if ((typeSel && typeSel.options.length>1) && (statusSel && statusSel.options.length>1)) return;
  try{
    const token = MKHubUI.getTokenOrRedirect();
    const s = await fetch('/settings', { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
    const types = s.client_types || [];
    const statuses = s.client_statuses || [];
    if (typeSel && typeSel.options.length<=1){ for (const it of types){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; typeSel.appendChild(o); } }
    if (statusSel && statusSel.options.length<=1){ for (const it of statuses){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; statusSel.appendChild(o); } }
  }catch(e){}
}
function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }
async function ensureGeoReady(){ for (let i=0;i<50;i++){ if (window.__MKGeo && typeof window.__MKGeo.populateStates==='function') return; await delay(50); } }
async function setAddressSelects(countryId, provinceId, cityId, country, province, city){
  const h=window.__MKGeo||{};
  const cSel=document.getElementById(countryId); const pSel=document.getElementById(provinceId); const ciSel=document.getElementById(cityId);
  if (!cSel || !pSel || !ciSel) return;
  if (country){ cSel.value = country; }
  const fnStates = countryId.startsWith('billing_') ? h.bPopulateStates : h.populateStates;
  const fnCities = countryId.startsWith('billing_') ? h.bPopulateCities : h.populateCities;
  if (fnStates) await fnStates(country || cSel.value);
  if (province){ pSel.value = province; }
  if (fnCities) await fnCities(country || cSel.value, province || pSel.value);
  if (city){ ciSel.value = city; }
}

load();
</script>


