<!doctype html>
<meta charset="utf-8">
<title>Customer</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<script src="/ui/geo.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>Customer</h2>
  <div id="info" class="card"></div>

  <div class="card">
    <h3>Details</h3>
    <div class="row">
      <div class="field"><label>Name *</label><input id="name" /></div>
      <div class="field"><label>Code</label><input id="code" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Billing email</label><input id="billing_email" /></div>
      <div class="field"><label>PO required</label><select id="po_required"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>Tax number</label><input id="tax_number" /></div>
    </div>
    <h4>Address</h4>
    <div class="row">
      <div class="field"><label>Address</label><input id="address" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="city"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <button id="save">Save</button>
      <a class="btn" href="/ui/customers.html">Back</a>
    </div>
    <pre id="msg" class="muted"></pre>
  </div>

  <div class="card">
    <h3>Files</h3>
    <div class="row">
      <input type="file" id="file" />
      <button id="upload">Upload</button>
    </div>
    <div id="filesList" class="card"></div>
  </div>

  <div class="card">
    <h3>Contacts</h3>
    <div id="contactsList" class="card"></div>
    <h4>Add Contact</h4>
    <div class="row">
      <div class="field"><label>Name</label><input id="c_name" /></div>
      <div class="field"><label>Email</label><input id="c_email" /></div>
      <div class="field"><label>Phone</label><input id="c_phone" /></div>
      <div class="field"><label>Primary</label><select id="c_primary"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <button id="addContact">Add Contact</button>
  </div>
</div>
<script>
MKHubUI.initSidebar('customers');
const params = new URLSearchParams(location.search);
const id = params.get('id');
function auth(){ return { Authorization:'Bearer '+MKHubUI.getTokenOrRedirect() }; }
async function load(){
  const r = await fetch('/clients/'+id, { headers: auth() });
  const info = document.getElementById('info');
  if (!r.ok){ info.textContent='Not authorized or not found.'; return; }
  const c = await r.json();
  info.innerHTML = `<strong>${c.name}</strong>${c.code?` <span class=muted>(${c.code})</span>`:''}` +
    `${c.city||c.province||c.country?`<div class=muted>${[c.city,c.province,c.country].filter(Boolean).join(', ')}</div>`:''}`;
  const set=(k,v)=>{ const el=document.getElementById(k); if (el) el.value=v||''; };
  for (const k of ['name','code','billing_email','tax_number','address','country','province','city']){ set(k, c[k]); }
  document.getElementById('po_required').value = c.po_required ? 'true':'false';
  await loadContacts();
}
async function save(){
  const body = {};
  for (const k of ['name','code','billing_email','tax_number','address','country','province','city']){ body[k] = document.getElementById(k).value || null; }
  body['po_required'] = document.getElementById('po_required').value === 'true';
  const r = await fetch('/clients/'+id, { method:'PATCH', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  document.getElementById('msg').textContent = await r.text();
  await load();
}
async function loadContacts(){
  const arr = await fetch('/clients/'+id, { headers: auth() }).then(x=>x.json()); // no dedicated list; reuse detail
  // There's no contacts list in detail response; call a future endpoint if added.
}
async function addContact(){
  const body = { name: document.getElementById('c_name').value || null, email: document.getElementById('c_email').value || null, phone: document.getElementById('c_phone').value || null, is_primary: document.getElementById('c_primary').value==='true' };
  const r = await fetch('/clients/'+id+'/contacts', { method:'POST', headers:{ 'Content-Type':'application/json', ...auth() }, body: JSON.stringify(body) });
  if (r.ok){ document.getElementById('c_name').value=''; document.getElementById('c_email').value=''; document.getElementById('c_phone').value=''; loadContacts(); }
}
document.getElementById('save').addEventListener('click', save);
document.getElementById('addContact').addEventListener('click', addContact);

// File uploads linked to client via category key
document.getElementById('upload').addEventListener('click', async ()=>{
  const f = document.getElementById('file').files[0]; if (!f) return;
  const token = MKHubUI.getTokenOrRedirect();
  const upReq = { project_id: null, client_id: id, employee_id: null, category_id: 'client-docs', original_name: f.name, content_type: f.type || 'application/octet-stream' };
  const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
  const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
  if (!putResp.ok) return;
  const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na' }) }).then(x=>x.json());
  // In a future improvement, we can store FileObject id onto a customer documents table
});

// Geo dropdowns
(async function initGeo(){
  await (window.MKHubGeo && window.MKHubGeo.load ? window.MKHubGeo.load() : Promise.resolve());
  const countrySel = document.getElementById('country');
  const stateSel = document.getElementById('province');
  const citySel = document.getElementById('city');
  const countries = (window.MKHubGeo && window.MKHubGeo.data) || [];
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; countrySel.appendChild(o); }
  async function populateStates(country){ stateSel.innerHTML='<option value="">Select...</option>'; citySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); } }
  async function populateCities(country,state){ citySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; citySel.appendChild(o); } }
  countrySel.addEventListener('change', e=>populateStates(e.target.value));
  stateSel.addEventListener('change', ()=>populateCities(countrySel.value, stateSel.value));
})();

load();
</script>


