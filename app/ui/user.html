<!doctype html>
<meta charset="utf-8">
<title>User Detail</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>User</h2>
  <div class="tabs">
    <a id="tab-personal" href="#" class="active" onclick="showTab(event,'personal')">Personal</a>
    <a id="tab-job" href="#" onclick="showTab(event,'job')">Job</a>
    <a id="tab-perms" href="#" onclick="showTab(event,'perms')">Permissions</a>
  </div>
  <div id="info" class="card"></div>
  <div id="personal" class="card" style="display:none">
    <h3>Personal Information</h3>
    <div class="row">
      <div class="field"><label>First name</label><input id="first" /></div>
      <div class="field"><label>Last name</label><input id="last" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Email (personal)</label><input id="email_personal" /></div>
      <div class="field"><label>Username</label><input id="username" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Mobile</label><input id="mobile" /></div>
    </div>
    <button onclick="save()">Save</button>
    <pre id="msg" class="muted"></pre>
  </div>
  <div id="job" class="card" style="display:none">
    <h3>Job Information</h3>
    <div class="row">
      <div class="field"><label>Hire date</label><input id="hire_date" type="date" /></div>
      <div class="field"><label>Employment type</label><input id="employment_type" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Work email</label><input id="work_email" /></div>
      <div class="field"><label>Work phone</label><input id="work_phone" /></div>
    </div>
    <button onclick="saveJob()">Save Job</button>
    <pre id="msgJob" class="muted"></pre>
  </div>
  <div id="roles" class="card" style="display:none">
    <h3>Roles & Permissions</h3>
    <div class="row">
      <div class="field"><label>Roles (comma separated)</label><input id="roles_in" placeholder="e.g. admin, manager" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Grant invite:send</label>
        <select id="perm_invite"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
      <div class="field"><label>Grant users:read</label>
        <select id="perm_users_read"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
      <div class="field"><label>Grant users:write</label>
        <select id="perm_users_write"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
    </div>
    <button onclick="saveRolesPerms()">Save Roles/Permissions</button>
    <pre id="msg2" class="muted"></pre>
  </div>
</div>
<script>
MKHubUI.initSidebar('users');
const params = new URLSearchParams(location.search);
const userId = params.get('id');
async function load(){
  const token = MKHubUI.getTokenOrRedirect();
  const r = await fetch('/auth/users/'+userId+'/profile', { headers:{ Authorization:'Bearer '+token }});
  const info = document.getElementById('info');
  if (!r.ok){ info.textContent='Not authorized.'; return; }
  const d = await r.json();
  info.innerHTML = `<strong>${d.user.username}</strong><br/><span class="muted">${d.user.email}</span>`;
  document.getElementById('personal').style.display = 'block';
  // Prefill personal fields
  document.getElementById('first').value = (d.profile && d.profile.first_name) || '';
  document.getElementById('last').value = (d.profile && d.profile.last_name) || '';
  document.getElementById('email_personal').value = (d.user && d.user.email) || '';
  document.getElementById('username').value = (d.user && d.user.username) || '';
  document.getElementById('mobile').value = (d.profile && d.profile.mobile_phone) || '';
  // moved job_title into Job tab
  // Prefill job
  document.getElementById('hire_date').value = (d.profile && (d.profile.hire_date || '').slice(0,10)) || '';
  document.getElementById('employment_type').value = (d.profile && d.profile.employment_type) || '';
  document.getElementById('work_email').value = (d.profile && d.profile.work_email) || '';
  document.getElementById('work_phone').value = (d.profile && d.profile.work_phone) || '';
  // Roles/Perms panel visible if current user likely an admin or has users:write (best-effort based on /auth/me)
  try {
    const me = await fetch('/auth/me', { headers:{ Authorization:'Bearer '+token }}).then(x=>x.json());
    const canAdmin = (me.roles||[]).includes('admin') || (me.permissions||[]).includes('users:write');
    if (canAdmin){
      document.getElementById('roles').style.display = 'block';
      const u = await fetch('/auth/users/'+userId, { headers:{ Authorization:'Bearer '+token }}).then(x=>x.json());
      document.getElementById('roles_in').value = (u.roles||[]).join(', ');
    }
  } catch(e) {}
}
async function save(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    first_name: document.getElementById('first').value || null,
    last_name: document.getElementById('last').value || null,
    mobile_phone: document.getElementById('mobile').value || null,
    job_title: document.getElementById('job').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  let txt = await r.text();
  // Save user core fields
  const u = {
    email_personal: document.getElementById('email_personal').value || null,
    username: document.getElementById('username').value || null,
  };
  const r2 = await fetch('/auth/users/'+userId, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(u) });
  txt += '\n' + await r2.text();
  document.getElementById('msg').textContent = txt;
}
async function saveJob(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    hire_date: document.getElementById('hire_date').value || null,
    termination_date: document.getElementById('termination_date').value || null,
    job_title: document.getElementById('job_title').value || null,
    division: document.getElementById('division').value || null,
    employment_type: document.getElementById('employment_type').value || null,
    pay_type: document.getElementById('pay_type').value || null,
    pay_rate: document.getElementById('pay_rate').value || null,
    manager_user_id: document.getElementById('manager_user_id').value || null,
    work_email: document.getElementById('work_email').value || null,
    work_phone: document.getElementById('work_phone').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  document.getElementById('msgJob').textContent = await r.text();
}
function showTab(ev, which){ ev && ev.preventDefault();
  for (const k of ['personal','job','perms']){ const el=document.getElementById(k==='perms'?'roles':k); if (el) el.style.display = (k===which) ? 'block':'none'; }
  for (const k of ['personal','job','perms']){ const t=document.getElementById('tab-'+k); if (t){ if (k===which) t.classList.add('active'); else t.classList.remove('active'); } }
}
// Default tab
showTab(null, 'personal');
async function saveRolesPerms(){
  const token = MKHubUI.getTokenOrRedirect();
  const roles = document.getElementById('roles_in').value.split(',').map(s=>s.trim()).filter(Boolean);
  const r1 = await fetch('/auth/users/'+userId+'/roles', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(roles) });
  const changes = {};
  const v = (id)=>{ const x=document.getElementById(id).value; return x===''?null:(x==='true'); };
  const inv=v('perm_invite'); if (inv!==null) changes['invite:send']=inv;
  const ur=v('perm_users_read'); if (ur!==null) changes['users:read']=ur;
  const uw=v('perm_users_write'); if (uw!==null) changes['users:write']=uw;
  let txt = await r1.text();
  if (Object.keys(changes).length){
    const r2 = await fetch('/auth/users/'+userId+'/permissions', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(changes) });
    txt += '\n' + await r2.text();
  }
  document.getElementById('msg2').textContent = txt;
}
load();
</script>

