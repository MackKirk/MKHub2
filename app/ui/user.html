<!doctype html>
<meta charset="utf-8">
<title>User Detail</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>User</h2>
  <div class="tabs">
    <a id="tab-personal" href="#" class="active" onclick="showTab(event,'personal')">Personal</a>
    <a id="tab-job" href="#" onclick="showTab(event,'job')">Job</a>
    <a id="tab-timeoff" href="#" onclick="showTab(event,'timeoff')">Time Off</a>
    <a id="tab-emergency" href="#" onclick="showTab(event,'emergency')">Emergency</a>
    <a id="tab-docs" href="#" onclick="showTab(event,'docs')">Documents</a>
    <a id="tab-notes" href="#" onclick="showTab(event,'notes')">Notes</a>
    <a id="tab-training" href="#" onclick="showTab(event,'training')">Training</a>
    <a id="tab-benefits" href="#" onclick="showTab(event,'benefits')">Benefits</a>
    <a id="tab-perms" href="#" onclick="showTab(event,'perms')">Permissions</a>
  </div>
  <div id="info" class="card"></div>
  <div id="personal" class="card" style="display:none">
    <h3>Personal Information</h3>
    <div class="row">
      <div class="field" style="max-width:220px">
        <label>Profile photo</label>
        <div style="display:flex;align-items:center;gap:10px">
          <img id="photo_preview" src="" alt="profile" style="width:64px;height:64px;object-fit:cover;border-radius:50%;background:#eee"/>
          <div>
            <input type="file" id="photo_file" accept="image/*"/>
            <button onclick="uploadPhoto()">Upload</button>
          </div>
        </div>
        <small class="muted">JPG/PNG, square recommended</small>
      </div>
    </div>
    <div class="row">
      <div class="field"><label>First name</label><input id="first" /></div>
      <div class="field"><label>Last name</label><input id="last" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Email (personal)</label><input id="email_personal" /></div>
      <div class="field"><label>Username</label><input id="username" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Mobile</label><input id="mobile" /></div>
    </div>
    <h4>Profile</h4>
    <div class="row">
      <div class="field"><label>Preferred name</label><input id="preferred_name" /></div>
      <div class="field"><label>Gender</label>
        <select id="p_gender">
          <option value="">Select...</option>
          <option>Female</option>
          <option>Male</option>
          <option>Non-binary</option>
          <option>Prefer not to say</option>
          <option>Other</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="field"><label>Marital status</label>
        <select id="p_marital">
          <option value="">Select...</option>
          <option>Single</option>
          <option>Married</option>
          <option>Common-law</option>
          <option>Divorced</option>
          <option>Widowed</option>
        </select>
      </div>
      <div class="field"><label>Date of birth</label><input id="p_dob" type="date" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Nationality</label><input id="p_nationality" /></div>
      <div class="field"><label>Home phone</label><input id="home_phone" /></div>
    </div>
    <h4>Address</h4>
    <div class="row">
      <div class="field"><label>Street 1</label><input id="address1" /></div>
      <div class="field"><label>Street 2</label><input id="address2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><input id="p_city" /></div>
      <div class="field"><label>Province/State</label><input id="p_province" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Postal code</label><input id="p_postal" /></div>
      <div class="field"><label>Country</label><input id="p_country" /></div>
    </div>
    <h4>Legal</h4>
    <div class="row">
      <div class="field"><label>SIN/SSN</label><input id="p_sin" /></div>
      <div class="field"><label>Work permit status</label><input id="p_work_permit" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Visa status</label><input id="p_visa" /></div>
    </div>
    <!-- Passports moved to Documents tab -->
    <h4>Education</h4>
    <div id="educationList" class="card"></div>
    <div class="row">
      <div class="field"><label>Institution</label><input id="ed_inst" /></div>
      <div class="field"><label>Degree</label><input id="ed_degree" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Major</label><input id="ed_major" /></div>
      <div class="field"><label>GPA</label><input id="ed_gpa" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Start</label><input id="ed_start" type="date" /></div>
      <div class="field"><label>End</label><input id="ed_end" type="date" /></div>
    </div>
    <button onclick="addEducation()">Add Education</button>
    <button onclick="save()">Save</button>
    <pre id="msg" class="muted"></pre>
  </div>
  <div id="job" class="card" style="display:none">
    <h3>Job Information</h3>
    <h4>Employment</h4>
    <div class="row">
      <div class="field"><label>Hire date (YYYY-MM-DD)</label><input id="hire_date" type="date" /></div>
      <div class="field"><label>Termination date (YYYY-MM-DD)</label><input id="termination_date" type="date" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Job title <span class="req">*</span></label><input id="job_title" /></div>
      <div class="field"><label>Division</label><input id="division" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Personal email</label><input id="job_email_personal" readonly /></div>
      <div class="field"><label>Work email</label><input id="work_email" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Work phone</label><input id="work_phone" /></div>
      <div class="field"><label>Manager</label>
        <select id="manager_user_id"><option value="">Select...</option></select>
      </div>
    </div>
    <div class="row">
      <div class="field"><label>Pay rate</label><input id="pay_rate" type="number" step="1" /></div>
      <div class="field"><label>Pay type</label>
        <select id="pay_type">
          <option value="">Select...</option>
          <option>hourly</option>
          <option>salary</option>
          <option>contract</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="field"><label>Employment type</label>
        <select id="employment_type">
          <option value="">Select...</option>
          <option>full-time</option>
          <option>part-time</option>
          <option>contract</option>
        </select>
      </div>
    </div>
    <button onclick="saveJob()">Save Job</button>
    <pre id="msgJob" class="muted"></pre>
  </div>
  <div id="emergency" class="card" style="display:none">
    <h3>Emergency Contacts</h3>
    <div id="emergList" class="card"></div>
    <h4>Add Contact</h4>
    <div class="row">
      <div class="field"><label>Name</label><input id="e_name" /></div>
      <div class="field"><label>Relationship</label><input id="e_rel" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Mobile</label><input id="e_mobile" /></div>
      <div class="field"><label>Email</label><input id="e_email" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Address</label><input id="e_address" /></div>
      <div class="field"><label>Primary</label>
        <select id="e_primary"><option value="false">No</option><option value="true">Yes</option></select>
      </div>
    </div>
    <button onclick="addEmergency()">Add</button>
    <pre id="msgEmerg" class="muted"></pre>
  </div>
  <div id="docs" class="card" style="display:none">
    <h3>Documents</h3>
    <div id="docsList" class="card"></div>
    <h4>Add Document</h4>
    <div class="row">
      <div class="field"><label>Type</label>
        <select id="doc_type">
          <option value="passport">Passport</option>
          <option value="driver_license">Driver Licence</option>
          <option value="bc_registration">BC Registration</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="field"><label>Title</label><input id="doc_title" placeholder="e.g., Canadian Passport" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Number</label><input id="doc_number" /></div>
      <div class="field"><label>Issuing country</label><input id="doc_country" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Issued</label><input id="doc_issued" type="date" /></div>
      <div class="field"><label>Expiry</label><input id="doc_expiry" type="date" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>Notes</label><input id="doc_notes" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>Attach file (optional)</label>
        <input type="file" id="doc_file" />
      </div>
    </div>
    <button onclick="addDocument()">Add Document</button>
    <pre id="msgDocs" class="muted"></pre>
  </div>
  <div id="roles" class="card" style="display:none">
    <h3>Roles & Permissions</h3>
    <div class="row">
      <div class="field"><label>Roles (comma separated)</label><input id="roles_in" placeholder="e.g. admin, manager" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Grant invite:send</label>
        <select id="perm_invite"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
      <div class="field"><label>Grant users:read</label>
        <select id="perm_users_read"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
      <div class="field"><label>Grant users:write</label>
        <select id="perm_users_write"><option value="">No change</option><option value="true">Grant</option><option value="false">Revoke</option></select>
      </div>
    </div>
    <button onclick="saveRolesPerms()">Save Roles/Permissions</button>
    <pre id="msg2" class="muted"></pre>
  </div>
</div>
<script>
MKHubUI.initSidebar('users');
const params = new URLSearchParams(location.search);
const userId = params.get('id');
async function load(){
  const token = MKHubUI.getTokenOrRedirect();
  const r = await fetch('/auth/users/'+userId+'/profile', { headers:{ Authorization:'Bearer '+token }});
  const info = document.getElementById('info');
  if (!r.ok){ info.textContent='Not authorized.'; return; }
  const d = await r.json();
  info.innerHTML = `<strong>${d.user.username}</strong><br/><span class=\"muted\">${d.user.email}</span>`;
  // photo
  const photoId = d.profile && d.profile.profile_photo_file_id;
  if (photoId){
    try {
      const ph = await fetch('/files/'+photoId+'/download').then(x=>x.json());
      info.innerHTML = `<div style=\"display:flex;gap:12px;align-items:center\">`+
        `<img src=\"${ph.download_url}\" alt=\"profile\" style=\"width:64px;height:64px;object-fit:cover;border-radius:50%\" />`+
        `<div><strong>${d.user.username}</strong><br/><span class=muted>${d.user.email}</span></div>`+
      `</div>`;
      const pv = document.getElementById('photo_preview'); if (pv) pv.src = ph.download_url;
    } catch(e) {}
  }
  document.getElementById('personal').style.display = 'block';
  // Prefill personal fields
  document.getElementById('first').value = (d.profile && d.profile.first_name) || '';
  document.getElementById('last').value = (d.profile && d.profile.last_name) || '';
  document.getElementById('email_personal').value = (d.user && d.user.email) || '';
  document.getElementById('username').value = (d.user && d.user.username) || '';
  document.getElementById('mobile').value = (d.profile && d.profile.mobile_phone) || '';
  // moved job_title into Job tab
  // Prefill job
  document.getElementById('hire_date').value = (d.profile && (d.profile.hire_date || '').slice(0,10)) || '';
  document.getElementById('termination_date').value = (d.profile && (d.profile.termination_date || '').slice(0,10)) || '';
  document.getElementById('job_title').value = (d.profile && d.profile.job_title) || '';
  document.getElementById('division').value = (d.profile && d.profile.division) || '';
  document.getElementById('employment_type').value = (d.profile && d.profile.employment_type) || '';
  document.getElementById('work_email').value = (d.profile && d.profile.work_email) || '';
  document.getElementById('work_phone').value = (d.profile && d.profile.work_phone) || '';
  document.getElementById('pay_type').value = (d.profile && d.profile.pay_type) || '';
  document.getElementById('pay_rate').value = (d.profile && d.profile.pay_rate) || '';
  document.getElementById('job_email_personal').value = (d.user && d.user.email) || '';
  // Manager options
  try {
    const opts = await fetch('/auth/users/options', { headers:{ Authorization:'Bearer '+token }}).then(x=>x.json());
    const sel = document.getElementById('manager_user_id');
    if (Array.isArray(opts)){
      for (const uo of opts){ const o=document.createElement('option'); o.value=uo.id; o.textContent=uo.username + ' ('+uo.email+')'; sel.appendChild(o); }
    }
    if (d.profile && d.profile.manager_user_id){ sel.value = d.profile.manager_user_id; }
  } catch(e) {}
  // Prefill personal extended
  document.getElementById('preferred_name').value = (d.profile && d.profile.preferred_name) || '';
  document.getElementById('p_gender').value = (d.profile && d.profile.gender) || '';
  document.getElementById('p_marital').value = (d.profile && d.profile.marital_status) || '';
  document.getElementById('p_dob').value = (d.profile && (d.profile.date_of_birth || '').slice(0,10)) || '';
  document.getElementById('p_nationality').value = (d.profile && d.profile.nationality) || '';
  document.getElementById('home_phone').value = (d.profile && d.profile.phone) || '';
  document.getElementById('address1').value = (d.profile && d.profile.address_line1) || '';
  document.getElementById('address2').value = (d.profile && d.profile.address_line2) || '';
  document.getElementById('p_city').value = (d.profile && d.profile.city) || '';
  document.getElementById('p_province').value = (d.profile && d.profile.province) || '';
  document.getElementById('p_postal').value = (d.profile && d.profile.postal_code) || '';
  document.getElementById('p_country').value = (d.profile && d.profile.country) || '';
  document.getElementById('p_sin').value = (d.profile && d.profile.sin_number) || '';
  document.getElementById('p_work_permit').value = (d.profile && d.profile.work_permit_status) || '';
  document.getElementById('p_visa').value = (d.profile && d.profile.visa_status) || '';
  // Load passports and education
  try {
    const token2 = MKHubUI.getTokenOrRedirect();
    const [ed, docs] = await Promise.all([
      fetch('/auth/users/'+userId+'/education', { headers:{ Authorization:'Bearer '+token2 }}).then(x=>x.json()),
      fetch('/auth/users/'+userId+'/documents', { headers:{ Authorization:'Bearer '+token2 }}).then(x=>x.json()),
    ]);
    const el = document.getElementById('educationList');
    if (el) el.innerHTML = (ed||[]).map(e=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0">`+
      `<div>${e.college_institution||''} — ${e.degree||''} ${e.major_specialization||''} (${(e.start_date||'').slice(0,10)} → ${(e.end_date||'').slice(0,10)})</div>`+
      `<button onclick=\"delEducation('${e.id}')\">Remove</button>`+
    `</div>`).join('') || 'No education records';
    const dl = document.getElementById('docsList');
    if (dl) dl.innerHTML = (docs||[]).map(d=>`<div style=\"display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0\">`+
      `<div>[${d.doc_type}] ${d.title||d.number||''} — ${d.issuing_country||''} ${(d.issued_date||'').slice(0,10)} → ${(d.expiry_date||'').slice(0,10)}</div>`+
      `<div>`+
        `${d.file_id ? `<button onclick=\"openFile('${d.file_id}')\">Download</button> ` : ''}`+
        `<button onclick=\"delDocument('${d.id}')\">Remove</button>`+
      `</div>`+
    `</div>`).join('') || 'No documents';
  } catch(e) {}
  // Roles/Perms panel visible if current user likely an admin or has users:write (best-effort based on /auth/me)
  try {
    const me = await fetch('/auth/me', { headers:{ Authorization:'Bearer '+token }}).then(x=>x.json());
    const canAdmin = (me.roles||[]).includes('admin') || (me.permissions||[]).includes('users:write');
    const tabPerms = document.getElementById('tab-perms');
    if (tabPerms){ tabPerms.style.display = canAdmin ? 'inline-block' : 'none'; }
  } catch(e) {}
}
async function save(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    first_name: document.getElementById('first').value || null,
    last_name: document.getElementById('last').value || null,
    preferred_name: document.getElementById('preferred_name').value || null,
    gender: document.getElementById('p_gender').value || null,
    marital_status: document.getElementById('p_marital').value || null,
    date_of_birth: document.getElementById('p_dob').value || null,
    nationality: document.getElementById('p_nationality').value || null,
    phone: document.getElementById('home_phone').value || null,
    mobile_phone: document.getElementById('mobile').value || null,
    address_line1: document.getElementById('address1').value || null,
    address_line2: document.getElementById('address2').value || null,
    city: document.getElementById('p_city').value || null,
    province: document.getElementById('p_province').value || null,
    postal_code: document.getElementById('p_postal').value || null,
    country: document.getElementById('p_country').value || null,
    sin_number: document.getElementById('p_sin').value || null,
    work_permit_status: document.getElementById('p_work_permit').value || null,
    visa_status: document.getElementById('p_visa').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  let txt = await r.text();
  // Save user core fields
  const u = {
    email_personal: document.getElementById('email_personal').value || null,
    username: document.getElementById('username').value || null,
  };
  const r2 = await fetch('/auth/users/'+userId, { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(u) });
  txt += '\n' + await r2.text();
  document.getElementById('msg').textContent = txt;
}
async function saveJob(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    hire_date: document.getElementById('hire_date').value || null,
    termination_date: document.getElementById('termination_date').value || null,
    job_title: document.getElementById('job_title').value || null,
    division: document.getElementById('division').value || null,
    employment_type: document.getElementById('employment_type').value || null,
    pay_type: document.getElementById('pay_type').value || null,
    pay_rate: document.getElementById('pay_rate').value || null,
    manager_user_id: document.getElementById('manager_user_id').value || null,
    work_email: document.getElementById('work_email').value || null,
    work_phone: document.getElementById('work_phone').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  document.getElementById('msgJob').textContent = await r.text();
}
async function addPassport(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    passport_number: document.getElementById('pp_number').value || null,
    issuing_country: document.getElementById('pp_country').value || null,
    issued_date: document.getElementById('pp_issued').value || null,
    expiry_date: document.getElementById('pp_expiry').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/passports', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  const t = await r.text();
  document.getElementById('msg').textContent = t;
  load();
}
async function delPassport(id){
  const token = MKHubUI.getTokenOrRedirect();
  await fetch('/auth/users/'+userId+'/passports/'+id, { method:'DELETE', headers:{ Authorization:'Bearer '+token } });
  load();
}
async function addDocument(){
  const token = MKHubUI.getTokenOrRedirect();
  let fileId = null;
  const fileInput = document.getElementById('doc_file');
  const f = fileInput && fileInput.files && fileInput.files[0];
  if (f){
    // Request pre-signed upload URL
    const upReq = {
      project_id: null,
      client_id: null,
      employee_id: userId,
      category_id: 'employee-docs',
      original_name: f.name,
      content_type: f.type || 'application/octet-stream'
    };
    const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
    // Upload file directly to storage
    await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type }, body: f });
    // Confirm to create FileObject
    const sha = 'na'; // Optional: compute checksum client-side later
    const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: sha }) }).then(x=>x.json());
    fileId = conf.id;
  }
  const body = {
    doc_type: document.getElementById('doc_type').value || 'other',
    title: document.getElementById('doc_title').value || null,
    number: document.getElementById('doc_number').value || null,
    issuing_country: document.getElementById('doc_country').value || null,
    issued_date: document.getElementById('doc_issued').value || null,
    expiry_date: document.getElementById('doc_expiry').value || null,
    notes: document.getElementById('doc_notes').value || null,
    file_id: fileId,
  };
  const r = await fetch('/auth/users/'+userId+'/documents', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  const t = await r.text();
  document.getElementById('msgDocs').textContent = t;
  load();
}
async function delDocument(id){
  const token = MKHubUI.getTokenOrRedirect();
  await fetch('/auth/users/'+userId+'/documents/'+id, { method:'DELETE', headers:{ Authorization:'Bearer '+token } });
  load();
}
async function openFile(fileId){
  try {
    const r = await fetch('/files/'+fileId+'/download');
    const j = await r.json();
    if (j && j.download_url){ window.open(j.download_url, '_blank'); }
  } catch(e) {}
}
async function uploadPhoto(){
  const token = MKHubUI.getTokenOrRedirect();
  const inp = document.getElementById('photo_file');
  const f = inp && inp.files && inp.files[0];
  if (!f) return;
  const upReq = {
    project_id: null,
    client_id: null,
    employee_id: userId,
    category_id: 'employee-photo',
    original_name: f.name,
    content_type: f.type || 'image/jpeg'
  };
  const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
  await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type }, body: f });
  const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na' }) }).then(x=>x.json());
  const fileId = conf.id;
  // Save to profile
  await fetch('/auth/users/'+userId+'/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ profile_photo_file_id: fileId }) });
  // Update preview
  try{ const dl = await fetch('/files/'+fileId+'/download').then(x=>x.json()); const pv=document.getElementById('photo_preview'); if (pv && dl.download_url) pv.src = dl.download_url; }catch(e){}
}
async function addEducation(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    college_institution: document.getElementById('ed_inst').value || null,
    degree: document.getElementById('ed_degree').value || null,
    major_specialization: document.getElementById('ed_major').value || null,
    gpa: document.getElementById('ed_gpa').value || null,
    start_date: document.getElementById('ed_start').value || null,
    end_date: document.getElementById('ed_end').value || null,
  };
  const r = await fetch('/auth/users/'+userId+'/education', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  const t = await r.text();
  document.getElementById('msg').textContent = t;
  load();
}
async function delEducation(id){
  const token = MKHubUI.getTokenOrRedirect();
  await fetch('/auth/users/'+userId+'/education/'+id, { method:'DELETE', headers:{ Authorization:'Bearer '+token } });
  load();
}
async function addEmergency(){
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    name: document.getElementById('e_name').value || null,
    relationship: document.getElementById('e_rel').value || null,
    mobile_phone: document.getElementById('e_mobile').value || null,
    email: document.getElementById('e_email').value || null,
    address: document.getElementById('e_address').value || null,
    is_primary: document.getElementById('e_primary').value === 'true',
  };
  const r = await fetch('/auth/users/'+userId+'/emergency-contacts', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  const t = await r.text();
  document.getElementById('msgEmerg').textContent = t;
  await loadEmergency();
}
async function delEmergency(id){
  const token = MKHubUI.getTokenOrRedirect();
  await fetch('/auth/users/'+userId+'/emergency-contacts/'+id, { method:'DELETE', headers:{ Authorization:'Bearer '+token } });
  await loadEmergency();
}
async function loadEmergency(){
  try{
    const token = MKHubUI.getTokenOrRedirect();
    const lst = await fetch('/auth/users/'+userId+'/emergency-contacts', { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
    const el = document.getElementById('emergList');
    if (el) el.innerHTML = (lst||[]).map(e=>`<div style=\"display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0\">`+
      `<div>${e.name} — ${e.relationship||''} ${e.mobile_phone||''}</div>`+
      `<button onclick=\"delEmergency('${e.id}')\">Remove</button>`+
    `</div>`).join('') || 'No contacts';
  } catch(e) {}
}
function showTab(ev, which){ ev && ev.preventDefault();
  const tabs=['personal','job','timeoff','emergency','docs','notes','training','benefits','perms'];
  for (const k of tabs){ const el=document.getElementById(k==='perms'?'roles':k); if (el) el.style.display = (k===which) ? 'block':'none'; }
  for (const k of tabs){ const t=document.getElementById('tab-'+k); if (t){ if (k===which) t.classList.add('active'); else t.classList.remove('active'); } }
  if (which === 'perms' && document.getElementById('roles').style.display === 'block'){
    // Lazy load roles only when tab opened
    const token = MKHubUI.getTokenOrRedirect();
    fetch('/auth/users/'+userId, { headers:{ Authorization:'Bearer '+token }})
      .then(x=>x.json()).then(u=>{ document.getElementById('roles_in').value = (u.roles||[]).join(', '); });
  }
  if (which === 'emergency'){
    loadEmergency();
  }
}
// Default tab
showTab(null, 'personal');
async function saveRolesPerms(){
  const token = MKHubUI.getTokenOrRedirect();
  const roles = document.getElementById('roles_in').value.split(',').map(s=>s.trim()).filter(Boolean);
  const r1 = await fetch('/auth/users/'+userId+'/roles', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(roles) });
  const changes = {};
  const v = (id)=>{ const x=document.getElementById(id).value; return x===''?null:(x==='true'); };
  const inv=v('perm_invite'); if (inv!==null) changes['invite:send']=inv;
  const ur=v('perm_users_read'); if (ur!==null) changes['users:read']=ur;
  const uw=v('perm_users_write'); if (uw!==null) changes['users:write']=uw;
  let txt = await r1.text();
  if (Object.keys(changes).length){
    const r2 = await fetch('/auth/users/'+userId+'/permissions', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(changes) });
    txt += '\n' + await r2.text();
  }
  document.getElementById('msg2').textContent = txt;
}
load();
</script>

