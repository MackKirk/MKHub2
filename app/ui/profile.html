<!doctype html>
<meta charset="utf-8">
<title>My Profile</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<script src="/ui/countries.js"></script>
<script src="/ui/geo.js"></script>
<div id="sidebar"></div>
<div class="main">
 <div class="hero-card red">
  <div class="hero-left">
    <div class="avatar-wrap" onclick="document.getElementById('avatarFile').click()" title="Change photo">
      <img id="avatarPreview" class="avatar-lg" src="/ui/assets/login/logo-light.svg" alt="avatar">
      <div class="avatar-edit">✏️</div>
    </div>
    <div class="hero-right">
      <div class="hero-name" id="heroName">My Profile</div>
      <div class="hero-sub">Complete your information to unlock all features</div>
      <div class="hero-tabs">
        <a href="#" id="h-tab-personal" class="active" onclick="return switchPanel(event,'personal')">Personal</a>
        <a href="#" id="h-tab-job" onclick="return switchPanel(event,'job')">Job</a>
        <a href="#" id="h-tab-emergency" onclick="return switchPanel(event,'emergency')">Emergency</a>
        <a href="#" id="h-tab-docs" onclick="return switchPanel(event,'docs')">Documents</a>
      </div>
    </div>
  </div>
  <div class="hero-actions">
    <input type="file" id="avatarFile" accept="image/*" style="display:none">
    <button type="button" class="btn" id="uploadAvatar">Save Photo</button>
  </div>
 </div>
<!-- tabs moved into hero -->
<p class="muted">Please complete your profile before using the system. Fields marked with <span class="req">*</span> are required.</p>
<ul id="missingList" class="muted"></ul>
<form onsubmit="save(event)">
  <div class="card elev">
    <div class="section-header"><div class="section-title">Identity</div><span id="avatarMsg" class="muted"></span></div>
  <div id="panel-personal" class="panel active">
  <div class="profile-layout">
    <aside class="vitals" id="vitals">
      <h4>Vitals</h4>
      <div class="vlist">
        <div class="vitem"><span class="k">Email</span><span class="v" id="v_email">—</span></div>
        <div class="vitem"><span class="k">Role</span><span class="v" id="v_role">—</span></div>
        <div class="vitem"><span class="k">Hire Date</span><span class="v" id="v_hire">—</span></div>
        <div class="vitem"><span class="k">Manager</span><span class="v" id="v_manager">—</span></div>
      </div>
    </aside>
    <div>
  <div class="card elev">
    <div class="section-title"><img src="/ui/assets/icons/id-card.svg"> Identity <span class="chip red">Required</span></div>
    <div class="row">
      <div class="field"><label>First name <span class="req">*</span></label><input id="first" readonly /></div>
      <div class="field"><label>Middle name</label><input id="middle" readonly /></div>
      <div class="field"><label>Last name <span class="req">*</span></label><input id="last" readonly /></div>
      <div class="field"><label>Preferred name <span class="req">*</span></label><input id="preferred" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Gender <span class="req">*</span></label>
      <select id="gender">
        <option value="">Select...</option>
        <option>Female</option>
        <option>Male</option>
        <option>Non-binary</option>
        <option>Prefer not to say</option>
        <option>Other</option>
      </select>
      </div>
      <div class="field"><label>Marital status <span class="req">*</span></label>
      <select id="marital">
        <option value="">Select...</option>
        <option>Single</option>
        <option>Married</option>
        <option>Common-law</option>
        <option>Divorced</option>
        <option>Widowed</option>
      </select>
      </div>
    <div class="row">
      <div class="field"><label>Date of birth (YYYY-MM-DD) <span class="req">*</span></label><input id="dob" /><div id="ageOut" class="muted"></div></div>
      <div class="field"><label>Nationality <span class="req">*</span></label>
        <select id="nationality"><option value="">Select...</option></select>
      </div>
    </div>
  </div>

  <div class="card elev">
    <div class="section-title"><img src="/ui/assets/icons/contact.svg"> Contact & Address</div>
    <div class="row">
      <div class="field"><label>Phone</label><input id="phone" /></div>
      <div class="field"><label>Mobile phone <span class="req">*</span></label><input id="mobile" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Address line 1 <span class="req">*</span></label><input id="address1" /></div>
      <div class="field"><label>Address line 2</label><input id="address2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country <span class="req">*</span></label>
        <select id="country"><option value="">Select...</option></select>
      </div>
      <div class="field"><label>Province/State <span class="req">*</span></label>
        <select id="province"><option value="">Select...</option></select>
      </div>
    </div>
    <div class="row">
      <div class="field"><label>City <span class="req">*</span></label>
        <select id="city"><option value="">Select...</option></select>
      </div>
      <div class="field"><label>Postal code <span class="req">*</span></label><input id="postal" /></div>
    </div>
  </div>

  <div class="card elev">
    <div class="section-title"><img src="/ui/assets/icons/employment.svg"> Employment</div>
    <div class="row">
      <div class="field"><label>Hire date (YYYY-MM-DD)</label><input id="hire_date" readonly /></div>
      <div class="field"><label>Termination date (YYYY-MM-DD)</label><input id="termination_date" readonly /></div>
    </div>
    <div class="row">
      <div class="field"><label>Job title <span class="req">*</span></label><input id="job" /></div>
      <div class="field"><label>Division</label><input id="division" readonly /></div>
    </div>
    <div class="row">
      <div class="field"><label>Personal email</label><input id="personal_email" readonly /></div>
      <div class="field"><label>Work email</label><input id="work_email" readonly /></div>
    </div>
    <div class="row">
      <div class="field"><label>Work phone</label><input id="work_phone" readonly /></div>
      <div class="field"><label>Manager</label><select id="manager_user_id" disabled><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>Pay rate</label><input id="pay_rate" readonly /></div>
      <div class="field"><label>Pay type</label><select id="pay_type" disabled><option value="">Select...</option><option>hourly</option><option>salary</option><option>contract</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>Employment type</label><select id="employment_type" disabled><option value="">Select...</option><option>full-time</option><option>part-time</option><option>contract</option></select></div>
    </div>
  </div>

  <div class="card elev">
    <div class="section-title"><img src="/ui/assets/icons/legal.svg"> Legal & Emergency</div>
    <div class="row">
      <div class="field"><label>SIN/SSN <span class="req">*</span></label><input id="sin_number" /></div>
      <div class="field"><label>Work permit status <span class="req">*</span></label><input id="work_permit_status" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Visa status <span class="req">*</span></label><input id="visa_status" /></div>
      <div class="field"><label>Emergency contact name <span class="req">*</span></label><input id="emergency_contact_name" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Emergency contact relationship <span class="req">*</span></label><input id="emergency_contact_relationship" /></div>
      <div class="field"><label>Emergency contact phone <span class="req">*</span></label><input id="emergency_contact_phone" /></div>
    </div>
  </div>
  <div class="row" style="justify-content:flex-end"><button class="btn">Save</button></div>
    </div>
  </div>
  </div>
  <div id="panel-job" class="panel">
    <div class="card elev"><div class="section-title">Job Overview</div><div class="muted">Coming soon</div></div>
  </div>
  <div id="panel-emergency" class="panel">
    <div class="card elev"><div class="section-title">Emergency Contacts</div><div class="muted">Coming soon</div></div>
  </div>
  <div id="panel-docs" class="panel">
    <div class="card elev"><div class="section-title">Documents</div><div class="muted">Coming soon</div></div>
  </div>
</form>
<pre id="msg" class="muted"></pre>
<script>
const token = MKHubUI.getTokenOrRedirect();
MKHubUI.initSidebar('profile');
fetch('/auth/me/profile', { headers:{ Authorization:'Bearer '+token }}).then(r=>r.json()).then(d=>{
  if(d){
    const p = d.profile || {};
    const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value = v || ''};
    set('first', p.first_name || (d.user && d.user.first_name) || '');
    set('last', p.last_name || (d.user && d.user.last_name) || '');
    // Header name and role
    try{
      const firstName = p.first_name || (d.user && d.user.first_name) || '';
      const lastName = p.last_name || (d.user && d.user.last_name) || '';
      const hn = document.getElementById('heroName'); if (hn) hn.textContent = (firstName+" "+lastName).trim() || 'My Profile';
      const hs = document.querySelector('.hero-sub'); if (hs) hs.textContent = p.job_title || ' ';
    }catch(e){}
    const userEmail = (d.user && d.user.email) || '';
    set('personal_email', userEmail);
    const emailOut = document.getElementById('v_email'); if (emailOut) emailOut.textContent = userEmail;
    set('preferred', p.preferred_name);
    set('phone', p.phone); set('mobile', p.mobile_phone);
    document.getElementById('gender').value = p.gender || '';
    document.getElementById('marital').value = p.marital_status || '';
    set('dob', p.date_of_birth); 
    // Age calc
    try{
      const ageOut = document.getElementById('ageOut');
      if (p.date_of_birth && ageOut){ const d2=new Date(p.date_of_birth); const n=new Date(); let age=n.getFullYear()-d2.getFullYear(); const m=n.getMonth()-d2.getMonth(); if(m<0 || (m===0 && n.getDate()<d2.getDate())) age--; ageOut.textContent = 'Age: '+age; }
    }catch(e){}
    document.getElementById('nationality').value = p.nationality || '';
    set('address1', p.address_line1); set('address2', p.address_line2);
    // Stash initial geo to preselect after async geo loads
    window.MKHubInitialGeo = { country: p.country || '', province: p.province || '', city: p.city || '', nationality: p.nationality || '' };
    set('postal', p.postal_code); 
    set('hire_date', p.hire_date); set('termination_date', p.termination_date);
    const hireOut = document.getElementById('v_hire'); if (hireOut) hireOut.textContent = (p.hire_date || '—');
    set('job', p.job_title); set('division', p.division);
    const roleOut = document.getElementById('v_role'); if (roleOut) roleOut.textContent = (p.job_title || '—');
    set('work_email', p.work_email); set('work_phone', p.work_phone);
    document.getElementById('manager_user_id').value = p.manager_user_id || '';
    const mgrOut = document.getElementById('v_manager'); if (mgrOut) mgrOut.textContent = p.manager_user_id ? 'Selected' : '—';
    set('pay_rate', p.pay_rate);
    document.getElementById('pay_type').value = p.pay_type || '';
    document.getElementById('employment_type').value = p.employment_type || '';
    set('sin_number', p.sin_number); set('work_permit_status', p.work_permit_status);
    set('visa_status', p.visa_status);
    set('emergency_contact_name', p.emergency_contact_name);
    set('emergency_contact_relationship', p.emergency_contact_relationship);
    set('emergency_contact_phone', p.emergency_contact_phone);
    // Load current avatar if present
    try{
      const fid = p.profile_photo_file_id;
      if (fid){ const img=document.getElementById('avatarPreview'); if(img) img.src='/files/'+fid+'/thumbnail?w=120'; const tb=document.getElementById('tbAvatar'); if(tb) tb.src='/files/'+fid+'/thumbnail?w=80'; }
    }catch(e){}
    // Show missing required fields as a bullet list
    const required = {
      preferred_name: 'Preferred name', gender: 'Gender', date_of_birth: 'Date of birth', marital_status: 'Marital status', nationality: 'Nationality',
      mobile_phone: 'Mobile phone', address_line1: 'Address line 1', city: 'City', province: 'Province/State', postal_code: 'Postal code', country: 'Country',
      sin_number: 'SIN/SSN', work_permit_status: 'Work permit status', visa_status: 'Visa status',
      emergency_contact_name: 'Emergency contact name', emergency_contact_relationship: 'Emergency contact relationship', emergency_contact_phone: 'Emergency contact phone',
    };
    const missing = [];
    const first = p.first_name || (d.user && d.user.first_name);
    const last = p.last_name || (d.user && d.user.last_name);
    if (!first) missing.push('First name');
    if (!last) missing.push('Last name');
    for (const [key,label] of Object.entries(required)){
      if (!p || !p[key]) missing.push(label);
    }
    const ul = document.getElementById('missingList');
    if (ul){ ul.innerHTML = missing.length ? missing.map(m=>`<li>- missing ${m}</li>`).join('') : '<li>All required fields completed.</li>'; }

    // Try preselect if geo already loaded
    if (window.MKHubGeoReady && typeof window.MKHubTryPreselect === 'function') { window.MKHubTryPreselect(); }
  }
});

function switchPanel(ev, which){ ev && ev.preventDefault(); const tabs=['personal','job','emergency','docs']; for (const k of tabs){ const el=document.getElementById('panel-'+k); if(el) el.className = 'panel' + (k===which?' active':''); const t1=document.getElementById('tab-'+k); if(t1){ if(k===which) t1.classList.add('active'); else t1.classList.remove('active'); } const t2=document.getElementById('h-tab-'+k); if(t2){ if(k===which) t2.classList.add('active'); else t2.classList.remove('active'); } } return false; }

async function save(ev){
  ev.preventDefault();
  const body = {
    first_name: document.getElementById('first').value || null,
    last_name: document.getElementById('last').value || null,
    preferred_name: document.getElementById('preferred').value || null,
    phone: document.getElementById('phone').value || null,
    mobile_phone: document.getElementById('mobile').value || null,
    gender: document.getElementById('gender').value || null,
    marital_status: document.getElementById('marital').value || null,
    date_of_birth: document.getElementById('dob').value || null,
    nationality: document.getElementById('nationality').value || null,
    address_line1: document.getElementById('address1').value || null,
    address_line2: document.getElementById('address2').value || null,
    city: document.getElementById('city').value || null,
    province: document.getElementById('province').value || null,
    postal_code: document.getElementById('postal').value || null,
    country: document.getElementById('country').value || null,
    hire_date: document.getElementById('hire_date').value || null,
    termination_date: document.getElementById('termination_date').value || null,
    job_title: document.getElementById('job').value || null,
    division: document.getElementById('division').value || null,
    work_email: document.getElementById('work_email').value || null,
    work_phone: document.getElementById('work_phone').value || null,
    manager_user_id: document.getElementById('manager_user_id').value || null,
    pay_rate: document.getElementById('pay_rate').value || null,
    pay_type: document.getElementById('pay_type').value || null,
    employment_type: document.getElementById('employment_type').value || null,
    sin_number: document.getElementById('sin_number').value || null,
    work_permit_status: document.getElementById('work_permit_status').value || null,
    visa_status: document.getElementById('visa_status').value || null,
    emergency_contact_name: document.getElementById('emergency_contact_name').value || null,
    emergency_contact_relationship: document.getElementById('emergency_contact_relationship').value || null,
    emergency_contact_phone: document.getElementById('emergency_contact_phone').value || null,
  };
  const r = await fetch('/auth/me/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+MKHubUI.getTokenOrRedirect() }, body: JSON.stringify(body) });
  const txt = await r.text();
  document.getElementById('msg').textContent = txt;
  // Update missing indicator from current inputs
  const reqIds = ['preferred','gender','dob','marital','nationality','mobile','address1','city','province','postal','country','sin_number','work_permit_status','visa_status','emergency_contact_name','emergency_contact_relationship','emergency_contact_phone'];
  const labels = { preferred:'Preferred name', gender:'Gender', dob:'Date of birth', marital:'Marital status', nationality:'Nationality', mobile:'Mobile phone', address1:'Address line 1', city:'City', province:'Province/State', postal:'Postal code', country:'Country', sin_number:'SIN/SSN', work_permit_status:'Work permit status', visa_status:'Visa status', emergency_contact_name:'Emergency contact name', emergency_contact_relationship:'Emergency contact relationship', emergency_contact_phone:'Emergency contact phone' };
  const missingNow = [];
  for (const id of reqIds){ const el=document.getElementById(id); const v = el && (el.value||''); if (!v) missingNow.push(labels[id]||id); }
  const ul = document.getElementById('missingList'); if (ul){ ul.innerHTML = missingNow.length ? missingNow.map(m=>`<li>- missing ${m}</li>`).join('') : '<li>All required fields completed.</li>'; }
}

// Upload avatar handler
(function(){
  const btn = document.getElementById('uploadAvatar');
  if (!btn) return;
  btn.addEventListener('click', async ()=>{
    const f = document.getElementById('avatarFile').files[0]; if(!f){ const m=document.getElementById('avatarMsg'); if(m) m.textContent='Choose an image first'; return; }
    try{
      const token = MKHubUI.getTokenOrRedirect();
      const upReq = { project_id:null, client_id:null, employee_id:null, category_id:'profile-photo', original_name:f.name, content_type:f.type||'image/jpeg' };
      const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
      const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
      if(!putResp.ok) throw new Error('upload failed');
      const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na', content_type: (f.type||'image/jpeg') }) }).then(x=>x.json());
      await fetch('/auth/me/profile', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ profile_photo_file_id: conf.id }) });
      const prev=document.getElementById('avatarPreview'); if(prev) prev.src = '/files/'+conf.id+'/thumbnail?w=120';
      const tb=document.getElementById('tbAvatar'); if (tb) tb.src = '/files/'+conf.id+'/thumbnail?w=80';
      const m=document.getElementById('avatarMsg'); if(m) m.textContent = 'Updated';
    }catch(e){ const m=document.getElementById('avatarMsg'); if(m) m.textContent='Failed to upload'; }
  });
})();

// Populate country/state/city with geo loader
const countrySel = document.getElementById('country');
const stateInp = document.getElementById('province');
const citySel = document.getElementById('city');
const nationalitySel = document.getElementById('nationality');
(async function initGeo(){
  await (window.MKHubGeo && window.MKHubGeo.load ? window.MKHubGeo.load() : Promise.resolve());
  const countries = (window.MKHubGeo && window.MKHubGeo.data) || [];
  for (const c of countries){
    const opt1=document.createElement('option'); opt1.value=c.name; opt1.textContent=c.name; if(countrySel) countrySel.appendChild(opt1);
    const opt2=document.createElement('option'); opt2.value=c.name; opt2.textContent=c.name; if(nationalitySel) nationalitySel.appendChild(opt2);
  }
  async function populateStates(country){
    stateInp.innerHTML = '<option value="">Select...</option>';
    citySel.innerHTML='<option value="">Select...</option>';
    const states = window.MKHubGeo.getStates ? await window.MKHubGeo.getStates(country) : [];
    for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; stateInp.appendChild(o); }
  }
  async function populateCities(country, state){
    citySel.innerHTML = '<option value="">Select...</option>';
    const cities = window.MKHubGeo.getCities ? await window.MKHubGeo.getCities(country, state) : [];
    for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; citySel.appendChild(o); }
  }
  countrySel && countrySel.addEventListener('change', e=>populateStates(e.target.value));
  stateInp && stateInp.addEventListener('change', ()=>populateCities(countrySel.value, stateInp.value));
  // Expose a preselect helper so either side can trigger when both are ready
  window.MKHubGeoReady = true;
  window.MKHubTryPreselect = async function(){
    const init = window.MKHubInitialGeo || {};
    if (!init.country) return;
    countrySel.value = init.country;
    // Set nationality too if present
    if (init.nationality) { const nat = document.getElementById('nationality'); if (nat) nat.value = init.nationality; }
    await populateStates(init.country);
    if (init.province){ stateInp.value = init.province; await populateCities(init.country, init.province); }
    if (init.city){ citySel.value = init.city; }
  };
  // Attempt preselect now (in case profile already loaded)
  if (typeof window.MKHubTryPreselect === 'function') { window.MKHubTryPreselect(); }
})();

// Populate manager options
(async function loadManagers(){
  const token = MKHubUI.getTokenOrRedirect();
  try{
    const r = await fetch('/auth/users/options', { headers:{ Authorization:'Bearer '+token }});
    if (r.ok){
      const arr = await r.json();
      const sel = document.getElementById('manager_user_id');
      if (sel){
        sel.innerHTML = '<option value="">Select...</option>' + arr.map(u=>`<option value="${u.id}">${u.username} (${u.email})</option>`).join('');
      }
    }
  } catch(e){}
})();
</script>
</div>
