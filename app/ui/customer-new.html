<!doctype html>
<meta charset="utf-8">
<title>New Customer</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<script src="/ui/geo.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>New Customer</h2>
  <div class="card">
    <div class="row">
      <div class="field" style="flex:1"><label>All fields (flat JSON)</label><textarea id="all_fields" placeholder="Optional: paste JSON to override form values" style="width:100%;height:120px"></textarea></div>
    </div>
    <h3>Quick Fields</h3>
    <div class="row">
      <div class="field"><label>Name (required)</label><input id="name" required placeholder="internal canonical name" /></div>
      <div class="field"><label>Display name</label><input id="display_name" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Type</label><select id="client_type"><option value="">Select...</option></select></div>
      <div class="field"><label>Status</label><select id="client_status"><option value="">Select...</option></select></div>
    </div>
    <h3>Details</h3>
    <div class="row">
      <div class="field"><label>Legal name</label><input id="legal_name" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>Lead source</label><input id="lead_source" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>Description / Notes</label><input id="description" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Billing email</label><input id="billing_email" type="email" /></div>
      <div class="field"><label>PO required</label><select id="po_required"><option value="false">No</option><option value="true">Yes</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>Tax number</label><input id="tax_number" /></div>
    </div>
    <h4>Address</h4>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="postal_code" /></div>
    </div>
    <h4>Billing Address</h4>
    <div class="row">
      <div class="field"><label>Address 1</label><input id="billing_address_line1" /></div>
      <div class="field"><label>Address 2</label><input id="billing_address_line2" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Country</label><select id="billing_country"><option value="">Select...</option></select></div>
      <div class="field"><label>Province/State</label><select id="billing_province"><option value="">Select...</option></select></div>
    </div>
    <div class="row">
      <div class="field"><label>City</label><select id="billing_city"><option value="">Select...</option></select></div>
      <div class="field"><label>Postal/Zip</label><input id="billing_postal_code" /></div>
    </div>
    <h4>Communication Preferences</h4>
    <div class="row">
      <div class="field"><label>Language</label><input id="preferred_language" /></div>
      <div class="field"><label>Preferred channels (comma-separated)</label><input id="preferred_channels" placeholder="Email, Phone, SMS"/></div>
    </div>
    <div class="row">
      <div class="field"><label>Marketing opt-in</label><select id="marketing_opt_in"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field"><label>Invoice delivery</label><input id="invoice_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
      <div class="field"><label>Statement delivery</label><input id="statement_delivery_method" placeholder="Email PDF, Portal, Mail"/></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for invoices (comma-separated)</label><input id="cc_emails_for_invoices" /></div>
    </div>
    <div class="row">
      <div class="field" style="flex:1"><label>CC emails for estimates (comma-separated)</label><input id="cc_emails_for_estimates" /></div>
    </div>
    <div class="row">
      <div class="field"><label>Do not contact</label><select id="do_not_contact"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="field" style="flex:1"><label>Reason</label><input id="do_not_contact_reason" /></div>
    </div>
    <div class="row">
      <button id="save">Create Customer</button>
      <a class="btn" href="/ui/customers.html">Cancel</a>
    </div>
    <pre id="msg" class="muted"></pre>
    <h4>Debug</h4>
    <div class="row">
      <div class="field" style="flex:1">
        <label>Outgoing JSON</label>
        <textarea id="dbg_body" style="width:100%;height:140px"></textarea>
      </div>
      <div class="field" style="flex:1">
        <label>Server response</label>
        <textarea id="dbg_resp" style="width:100%;height:140px"></textarea>
      </div>
    </div>
  </div>
</div>
<script>
MKHubUI.initSidebar('customer-new');
document.getElementById('save').addEventListener('click', async ()=>{
  const token = MKHubUI.getTokenOrRedirect();
  const body = {
    name: (document.getElementById('name').value || document.getElementById('display_name').value || '').trim(),
    display_name: (document.getElementById('display_name').value || '').trim(),
    legal_name: document.getElementById('legal_name').value || null,
    // code is auto-generated server-side
    client_type: document.getElementById('client_type').value || null,
    client_status: document.getElementById('client_status').value || null,
    lead_source: document.getElementById('lead_source').value || null,
    description: document.getElementById('description').value || null,
    billing_email: document.getElementById('billing_email').value || null,
    po_required: document.getElementById('po_required').value === 'true',
    tax_number: document.getElementById('tax_number').value || null,
    address_line1: document.getElementById('address_line1').value || null,
    address_line2: document.getElementById('address_line2').value || null,
    country: document.getElementById('country').value || null,
    province: document.getElementById('province').value || null,
    city: document.getElementById('city').value || null,
    postal_code: document.getElementById('postal_code').value || null,
    billing_address_line1: document.getElementById('billing_address_line1').value || null,
    billing_address_line2: document.getElementById('billing_address_line2').value || null,
    billing_country: document.getElementById('billing_country').value || null,
    billing_province: document.getElementById('billing_province').value || null,
    billing_city: document.getElementById('billing_city').value || null,
    billing_postal_code: document.getElementById('billing_postal_code').value || null,
    preferred_language: document.getElementById('preferred_language').value || null,
    preferred_channels: (document.getElementById('preferred_channels').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    marketing_opt_in: document.getElementById('marketing_opt_in').value === 'true',
    invoice_delivery_method: document.getElementById('invoice_delivery_method').value || null,
    statement_delivery_method: document.getElementById('statement_delivery_method').value || null,
    cc_emails_for_invoices: (document.getElementById('cc_emails_for_invoices').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    cc_emails_for_estimates: (document.getElementById('cc_emails_for_estimates').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    do_not_contact: document.getElementById('do_not_contact').value === 'true',
    do_not_contact_reason: document.getElementById('do_not_contact_reason').value || null,
  };
  // Allow override via flat JSON textarea for debugging
  try{
    const raw = document.getElementById('all_fields').value.trim();
    if (raw){
      const obj = JSON.parse(raw);
      Object.assign(body, obj);
    }
  }catch(e){ /* ignore json parse */ }
  // show outgoing body for debugging
  try { document.getElementById('dbg_body').value = JSON.stringify(body, null, 2); } catch(e) {}
  if (!body.name){ document.getElementById('msg').textContent='Display name is required.'; return; }
  const r = await fetch('/clients', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(body) });
  const txt = await r.text();
  try { document.getElementById('dbg_resp').value = txt; } catch(e) {}
  if (!r.ok){ document.getElementById('msg').textContent = txt; return; }
  location.href = '/ui/customers.html';
});
(async function initGeo(){
  await (window.MKHubGeo && window.MKHubGeo.load ? window.MKHubGeo.load() : Promise.resolve());
  const countrySel = document.getElementById('country');
  const stateSel = document.getElementById('province');
  const citySel = document.getElementById('city');
  const bCountrySel = document.getElementById('billing_country');
  const bStateSel = document.getElementById('billing_province');
  const bCitySel = document.getElementById('billing_city');
  const countries = (window.MKHubGeo && window.MKHubGeo.data) || [];
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; countrySel.appendChild(o); }
  for (const c of countries){ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; bCountrySel.appendChild(o); }
  async function populateStates(country){ stateSel.innerHTML='<option value="">Select...</option>'; citySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; stateSel.appendChild(o); } }
  async function populateCities(country,state){ citySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; citySel.appendChild(o); } }
  async function bPopulateStates(country){ bStateSel.innerHTML='<option value="">Select...</option>'; bCitySel.innerHTML='<option value="">Select...</option>'; const states=window.MKHubGeo.getStates?await window.MKHubGeo.getStates(country):[]; for (const s of states){ const o=document.createElement('option'); o.value=s; o.textContent=s; bStateSel.appendChild(o); } }
  async function bPopulateCities(country,state){ bCitySel.innerHTML='<option value="">Select...</option>'; const cities=window.MKHubGeo.getCities?await window.MKHubGeo.getCities(country,state):[]; for (const n of cities){ const o=document.createElement('option'); o.value=n; o.textContent=n; bCitySel.appendChild(o); } }
  countrySel.addEventListener('change', e=>populateStates(e.target.value));
  stateSel.addEventListener('change', ()=>populateCities(countrySel.value, stateSel.value));
  bCountrySel.addEventListener('change', e=>bPopulateStates(e.target.value));
  bStateSel.addEventListener('change', ()=>bPopulateCities(bCountrySel.value, bStateSel.value));
})();
// Load settings for dropdowns
(async function initSettings(){
  try{
    const token = MKHubUI.getTokenOrRedirect();
    const s = await fetch('/settings', { headers:{ Authorization:'Bearer '+token } }).then(x=>x.json());
    const types = s.client_types || [];
    const statuses = s.client_statuses || [];
    const typeSel = document.getElementById('client_type');
    const statusSel = document.getElementById('client_status');
    for (const it of types){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; typeSel.appendChild(o); }
    for (const it of statuses){ const o=document.createElement('option'); o.value=it.value||it.label; o.textContent=it.label; statusSel.appendChild(o); }
  }catch(e){}
})();
</script>


