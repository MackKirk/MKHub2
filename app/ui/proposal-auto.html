<!doctype html>
<meta charset="utf-8">
<title>Auto Proposal</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>Create Proposal (Auto)</h2>
  <div id="info" class="card"></div>
  <div class="card">
    <form id="proposalForm" enctype="multipart/form-data">
      <input type="hidden" id="client_id" />
      <input type="hidden" id="site_id" />
      <input type="hidden" id="project_id" />
      <input type="hidden" id="proposal_created_for" name="proposal_created_for" />
      <h3>Company Info</h3>
      <div class="field"><label>Document Type</label><input type="text" name="cover_title" maxlength="44" required></div>
      <div class="field"><label>Order Number</label><input type="text" id="order_number" name="order_number" maxlength="20" required readonly></div>
      <div class="field"><label>Company Name</label><input type="text" id="company_name" name="company_name" maxlength="50" required readonly></div>
      <div class="field"><label>Company Address</label><input type="text" id="company_address" name="company_address" maxlength="50" required readonly></div>
      <div class="field"><label>Date</label><input type="date" id="date" name="date" required></div>

      <h3>Project Details</h3>
      <div class="field"><label>Proposal Created For</label>
        <select id="contact_sel_for"></select>
      </div>
      <div class="field"><label>Primary Contact</label>
        <select id="contact_sel_primary"></select>
      </div>
      <div class="field"><label>Primary Contact Name</label><input type="text" id="contact_name" name="primary_contact_name" maxlength="40" readonly></div>
      <div class="field"><label>Primary Contact Phone</label><input type="text" id="contact_phone" name="primary_contact_phone" maxlength="15" readonly></div>
      <div class="field"><label>Primary Contact Email</label><input type="email" id="contact_email" name="primary_contact_email" maxlength="40" readonly></div>
      <div class="field"><label>Type of Project</label><input type="text" name="type_of_project" maxlength="55"></div>
      <div class="field"><label>Other Notes</label><textarea name="other_notes" maxlength="260"></textarea></div>

      <h3>Images</h3>
      <div class="field"><label>Cover Image</label>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
          <input type="file" name="cover_image" accept="image/*">
          <input type="hidden" id="cover_file_object_id" name="cover_file_object_id" />
          <button type="button" id="chooseCoverFromPics">Choose from Customer Pictures</button>
          <span id="coverPickInfo" class="muted"></span>
        </div>
      </div>
      <div class="field"><label>Page 2 Image</label>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
          <input type="file" name="page2_image" accept="image/*">
          <input type="hidden" id="page2_file_object_id" name="page2_file_object_id" />
          <button type="button" id="choosePage2FromPics">Choose from Customer Pictures</button>
          <span id="page2PickInfo" class="muted"></span>
        </div>
      </div>

      <h3>Project Sections</h3>
      <div id="sectionsContainer"></div>
      <button type="button" id="addSectionBtn">+ Add Section</button>

      <h3>Pricing</h3>
      <div class="field"><label>Bid Price</label><input type="number" step="0.01" name="bid_price" required></div>
      <div id="additionalCostsSection">
        <h4>Additional Costs</h4>
        <div id="costsContainer"></div>
        <button type="button" id="addCostBtn">+ Add Cost</button>
      </div>
      <h4>Total: <span id="calculatedTotal">$0.00</span></h4>

      <h3>Terms</h3>
      <div class="field"><label>Terms</label><textarea name="terms_text"></textarea></div>

      <div class="row" style="justify-content:space-between; align-items:center; gap:8px">
        <div>
          <button type="button" id="saveProposalBtn">Save Proposal</button>
        </div>
        <div>
      <button type="submit">Generate Proposal</button>
        </div>
      </div>
    </form>
    <pre id="msg" class="muted"></pre>
  </div>
  <div id="downloadSection" class="card" style="display:none;">
    <h3>Proposal Generated</h3>
    <a id="downloadLink" href="#" download="ProjectProposal.pdf">Download PDF</a>
  </div>
</div>

<!-- Image Picker Modal -->
<div id="imgPickerModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:9999">
  <div class="card" style="width:90%; max-width:900px; max-height:80%; overflow:auto;">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h3>Select Picture</h3>
      <button type="button" id="imgPickerClose">Close</button>
    </div>
    <div class="row" style="gap:8px; align-items:center; margin-bottom:8px">
      <input type="file" id="imgPickerUpload" accept="image/*" />
      <button type="button" id="imgPickerUploadBtn">Upload to Site</button>
      <span class="muted">Uploads attach to this site</span>
    </div>
    <div id="imgPickerGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px"></div>
    <div class="row" style="justify-content:space-between; margin-top:10px; align-items:center">
      <div class="muted" id="imgPickerHint"></div>
      <div style="display:flex; gap:8px">
        <button type="button" id="imgPickerEditBtn" disabled>Edit</button>
        <button type="button" id="imgPickerSelect" disabled>Select</button>
      </div>
    </div>
    <div id="imgPickerEditor" style="display:none; margin-top:10px">
      <div class="muted" id="imgEditHint"></div>
      <div style="display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap">
        <div style="position:relative">
          <canvas id="imgEditCanvas" style="background:#f6f6f6; max-width:100%; border:1px solid #eee"></canvas>
          <canvas id="imgEditOverlay" style="position:absolute; left:0; top:0; pointer-events:none"></canvas>
        </div>
        <div style="display:flex; flex-direction:column; gap:8px; min-width:240px">
          <div class="row" style="gap:6px; align-items:center; flex-wrap:wrap">
            <button type="button" id="imgEditModePan" class="active">Pan</button>
            <button type="button" id="imgEditModeRect">Rect</button>
            <button type="button" id="imgEditModeArrow">Arrow</button>
            <button type="button" id="imgEditModeText">Text</button>
          </div>
          <div class="row" style="gap:6px; align-items:center">
            <label>Color <input type="color" id="imgEditColor" value="#ff0000"></label>
            <label>Stroke <input type="number" id="imgEditStroke" min="1" max="20" value="3" style="width:60px"></label>
          </div>
          <div class="row" style="gap:6px; align-items:center">
            <label>Font <input type="text" id="imgEditFont" value="16px Montserrat" style="width:140px"></label>
            <label>Text <input type="text" id="imgEditText" placeholder="Your text" style="flex:1"></label>
          </div>
          <div class="row" style="gap:6px; align-items:center"><button type="button" id="imgEditRotateL">Rotate ⟲</button><button type="button" id="imgEditRotateR">Rotate ⟳</button></div>
          <label>Zoom <input type="range" id="imgEditZoom" min="0.5" max="3" value="1" step="0.01"></label>
          <div class="muted">Tips:
            <div>- Pan mode: drag image. Rect/Arrow/Text: click or drag on canvas.</div>
            <div>- Click an annotation to select, drag to move. Del key removes.</div>
          </div>
          <div class="row" style="gap:6px; justify-content:flex-end; flex-wrap:wrap">
            <button type="button" id="imgEditBack">Back</button>
            <button type="button" id="imgEditReset">Reset</button>
            <button type="button" id="imgEditApply">Apply</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <style>
    .modal-item{ border:1px solid #eee; padding:6px; text-align:center; background:#fff }
    .modal-item img{ max-width:100%; height:110px; object-fit:cover }
    .modal-item.active{ outline:2px solid #3b82f6 }
  </style>
</div>
<script src="/ui/image-picker.js"></script>
<script src="/ui/proposals.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Sidebar init with fallback if MKHubUI not present yet
  try{
    if (window.MKHubUI && typeof MKHubUI.initSidebar === 'function') {
MKHubUI.initSidebar('home');
    } else {
      const mount = document.getElementById('sidebar');
      if (mount) {
        const html = await fetch('/ui/sidebar.html?v=' + Date.now()).then(r=>r.text()).catch(()=>null);
        if (html) mount.outerHTML = html;
      }
    }
  }catch(e){}

const qp = new URLSearchParams(location.search);
const clientId = qp.get('client_id') || '';
const siteId = qp.get('site_id') || '';
const projectId = qp.get('project_id') || '';
  const clientHidden = document.getElementById('client_id'); if (clientHidden) clientHidden.value = clientId;
  const siteHidden = document.getElementById('site_id'); if (siteHidden) siteHidden.value = siteId;
  const projectHidden = document.getElementById('project_id'); if (projectHidden) projectHidden.value = projectId;

async function initPrefill(){
  try{
      const token = window.MKHubUI ? MKHubUI.getTokenOrRedirect() : localStorage.getItem('user_token');
      if (!clientId){ throw new Error('missing client'); }
      const cust = await fetch('/clients/'+clientId, { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json());
      const sites = await fetch('/clients/'+clientId+'/sites', { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json());
    const site = (sites||[]).find(s=>s.id===siteId) || null;
      const nameEl = document.getElementById('company_name'); if (nameEl) nameEl.value = (cust.display_name || cust.name || '').slice(0,50);
    const addr = site ? [site.site_address_line1, site.site_city, site.site_province, site.site_country].filter(Boolean).join(', ') : [cust.address_line1, cust.city, cust.province, cust.country].filter(Boolean).join(', ');
      const addrEl = document.getElementById('company_address'); if (addrEl) addrEl.value = addr.slice(0,50);
      // preset today's date
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const dateEl = document.getElementById('date'); if (dateEl) dateEl.value = `${yyyy}-${mm}-${dd}`;
      try{
        const code = await fetch('/proposals/next-code?client_id='+encodeURIComponent(clientId)).then(x=>x.json());
        if (code && code.order_number){ const on = document.getElementById('order_number'); if (on && !on.value) on.value = code.order_number; }
      }catch(e){}
      const contacts = await fetch('/clients/'+clientId+'/contacts', { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json()).catch(()=>[]);
      const selFor = document.getElementById('contact_sel_for');
      const selPrimary = document.getElementById('contact_sel_primary');
      const optsHtml = '<option value="">Select...</option>' + (contacts||[]).map(c=>`<option value="${c.id}" data-email="${c.email||''}" data-phone="${c.phone||''}" data-name="${c.name||''}" data-primary="${c.is_primary?'1':'0'}">${c.name||c.email||c.phone||c.id}</option>`).join('');
      if (selFor){ selFor.innerHTML = optsHtml; }
      if (selPrimary){ selPrimary.innerHTML = optsHtml; }
      function syncPrimaryDetails(){
        if (!selPrimary) return;
        const o = selPrimary.options[selPrimary.selectedIndex] || {};
          const nm = o.getAttribute ? (o.getAttribute('data-name')||'') : '';
          const setVal=(id,v)=>{ const el=document.getElementById(id); if (el) el.value=v; };
          setVal('contact_name', nm);
          setVal('contact_phone', o.getAttribute ? (o.getAttribute('data-phone')||'') : '');
          setVal('contact_email', o.getAttribute ? (o.getAttribute('data-email')||'') : '');
      }
      if (selFor){ selFor.addEventListener('change', ()=>{
        const o = selFor.options[selFor.selectedIndex] || {};
        const nm = o.getAttribute ? (o.getAttribute('data-name')||'') : '';
        const hidden = document.getElementById('proposal_created_for'); if (hidden) hidden.value = nm;
      }); }
      if (selPrimary){ selPrimary.addEventListener('change', syncPrimaryDetails); }
      // preselect primary contact in Primary dropdown; do not force in Created For
      if (selPrimary){ const primaryOpt = Array.from(selPrimary.options||[]).find(o=>o.getAttribute && o.getAttribute('data-primary')==='1'); if (primaryOpt){ selPrimary.value = primaryOpt.value; syncPrimaryDetails(); } }
      const info = document.getElementById('info');
      if (info){ info.innerHTML = `<strong>${cust.display_name || cust.name}</strong>${cust.code?` <span class=muted>(${cust.code})</span>`:''}` + (site?`<div class=muted>Site: ${(site.site_name||site.site_address_line1||'')}</div>`:''); }
    }catch(e){ const msg=document.getElementById('msg'); if (msg) msg.textContent = 'Prefill failed. Please ensure you opened from a site or are logged in.'; }
  }
  initPrefill();

  // Choose cover/page2 from customer pictures
  async function choosePic(target){
    try{
      if (!clientId){ alert('Missing customer'); return; }
      // Ensure picker script is loaded
      async function ensurePicker(){
        if (window.MKImagePicker && typeof MKImagePicker.open==='function') return true;
        const existing = document.getElementById('mk-image-picker-script');
        if (!existing){
          await new Promise((res)=>{
            const s=document.createElement('script'); s.id='mk-image-picker-script'; s.src='/ui/image-picker.js?ts='+Date.now(); s.onload=()=>res(); s.onerror=()=>res(); document.head.appendChild(s);
          });
        }
        // Give the browser a tick to execute
        await new Promise(res=>setTimeout(res, 0));
        return (window.MKImagePicker && typeof MKImagePicker.open==='function');
      }
      const ok = await ensurePicker(); if (!ok){ alert('Failed to load image picker'); return; }
      const picked = await MKImagePicker.open({ clientId, siteId, target });
      if (!picked) return;
      const fid = picked.file_object_id; const fname = picked.original_name || fid;
      if (target==='cover'){
        const hid = document.getElementById('cover_file_object_id'); if (hid) hid.value = fid;
        const info = document.getElementById('coverPickInfo'); if (info) info.textContent = fname;
        const fi = document.querySelector('input[name="cover_image"]'); if (fi) fi.value = '';
      } else if (target==='page2'){
        const hid = document.getElementById('page2_file_object_id'); if (hid) hid.value = fid;
        const info = document.getElementById('page2PickInfo'); if (info) info.textContent = fname;
        const fi = document.querySelector('input[name="page2_image"]'); if (fi) fi.value = '';
      } else {
        // Section
        const section = document.getElementById(target);
        if (section){
          const imagesBox = section.querySelector('[data-role="images-box"]');
          if (imagesBox){
            const wrapper = document.createElement('div'); wrapper.className='imageItem'; wrapper.dataset.fileId = fid; wrapper.innerHTML = `
              <div class="muted">From site: ${fname}</div>
              <label>Caption:
                <input type="text" maxlength="90">
              </label>
              <div class="inline-actions">
                <button type="button" class="btn-danger" data-action="remove-image">Remove image</button>
              </div>`;
            imagesBox.appendChild(wrapper);
            if (window.scheduleAutosave){ window.scheduleAutosave(); }
          }
        }
      }
    }catch(e){}
  }
  const btnCover = document.getElementById('chooseCoverFromPics'); if (btnCover){ btnCover.addEventListener('click', ()=>choosePic('cover')); }
  const btnPage2 = document.getElementById('choosePage2FromPics'); if (btnPage2){ btnPage2.addEventListener('click', ()=>choosePic('page2')); }

  // Modal controls
  const modal = document.getElementById('imgPickerModal');
  const modalClose = document.getElementById('imgPickerClose'); if (modalClose){ modalClose.addEventListener('click', ()=>{ modal.style.display='none'; }); }
  const modalSelect = document.getElementById('imgPickerSelect'); if (modalSelect){ modalSelect.addEventListener('click', ()=>{
    const fid = modalSelect.dataset.fileId || '';
    const fname = modalSelect.dataset.fileName || fid;
    const target = modal.dataset.target || '';
    if (!fid || !target){ return; }
    if (target==='cover'){
      const hid = document.getElementById('cover_file_object_id'); if (hid) hid.value = fid;
      const info = document.getElementById('coverPickInfo'); if (info) info.textContent = fname;
      const fi = document.querySelector('input[name="cover_image"]'); if (fi) fi.value = '';
    } else if (target==='page2'){
      const hid = document.getElementById('page2_file_object_id'); if (hid) hid.value = fid;
      const info = document.getElementById('page2PickInfo'); if (info) info.textContent = fname;
      const fi = document.querySelector('input[name="page2_image"]'); if (fi) fi.value = '';
    } else {
      // Section images: target holds section element id
      const section = document.getElementById(target);
      if (section){
        const imagesBox = section.querySelector('[data-role="images-box"]');
        if (imagesBox){
          // create imageItem with file_object_id
          const wrapper = document.createElement('div'); wrapper.className='imageItem';
          wrapper.dataset.fileId = fid;
          wrapper.innerHTML = `
            <div class="muted">From site: ${fname}</div>
            <label>Caption:
              <input type="text" maxlength="90">
            </label>
            <div class="inline-actions">
              <button type="button" class="btn-danger" data-action="remove-image">Remove image</button>
            </div>
          `;
          imagesBox.appendChild(wrapper);
          if (window.scheduleAutosave){ window.scheduleAutosave(); }
        }
      }
    }
    modal.style.display='none';
  }); }

  // Modal upload to site
  const upBtn = document.getElementById('imgPickerUploadBtn'); if (upBtn){ upBtn.addEventListener('click', async ()=>{
    try{
      const f = document.getElementById('imgPickerUpload').files[0]; if (!f){ alert('Choose an image'); return; }
      const token = window.MKHubUI ? MKHubUI.getTokenOrRedirect() : localStorage.getItem('user_token');
      // Upload to files service, then attach to site
      const upReq = { project_id: null, client_id: clientId, employee_id: null, category_id: 'site-docs', original_name: f.name, content_type: f.type || 'application/octet-stream' };
      const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
      const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': upReq.content_type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
      if (!putResp.ok){ alert('Upload failed'); return; }
      const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: f.size, checksum_sha256: 'na', content_type: (f.type||'application/octet-stream') }) }).then(x=>x.json());
      await fetch(`/clients/${encodeURIComponent(clientId)}/files?file_object_id=${encodeURIComponent(conf.id)}&category=site-docs&original_name=${encodeURIComponent(f.name)}&site_id=${encodeURIComponent(siteId||'')}`, { method:'POST', headers:{ Authorization:'Bearer '+token } });
      // Refresh grid
      choosePic(modal.dataset.target||'cover');
    }catch(e){ alert('Upload failed'); }
  }); }

  // --- Editor logic ---
  const editorBox = document.getElementById('imgPickerEditor');
  const editorHint = document.getElementById('imgEditHint');
  const canvas = document.getElementById('imgEditCanvas');
  const overlay = document.getElementById('imgEditOverlay');
  const zoomEl = document.getElementById('imgEditZoom');
  let editState = { img:null, angle:0, scale:1, offsetX:0, offsetY:0, aspect:1.0, fileId:'', fileName:'', mode:'pan', color:'#ff0000', stroke:3, font:'16px Montserrat', text:'', items:[], selectedId:null };
  function targetAspect(){ const t = modal.dataset.target||''; if (t==='cover') return 566/537; if (t==='page2') return 540/340; return 260/150; }
  function resetEditor(){ editState.angle=0; editState.scale=1; editState.offsetX=0; editState.offsetY=0; zoomEl.value='1'; }
  function setCanvasSize(){ const maxW = 800; const w = Math.min(maxW, (modal.clientWidth||900)-120); const aspect = editState.aspect; canvas.width = w; canvas.height = Math.round(w/aspect); overlay.width = canvas.width; overlay.height = canvas.height; }
  function drawBase(){ const ctx = canvas.getContext('2d'); ctx.save(); ctx.clearRect(0,0,canvas.width, canvas.height); ctx.fillStyle = '#f6f6f6'; ctx.fillRect(0,0,canvas.width, canvas.height); if (!editState.img){ ctx.restore(); return; } ctx.translate(canvas.width/2 + editState.offsetX, canvas.height/2 + editState.offsetY); ctx.rotate(editState.angle * Math.PI/180); const iw = editState.img.width; const ih = editState.img.height; const scale = editState.scale; const drawW = iw * scale; const drawH = ih * scale; ctx.drawImage(editState.img, -drawW/2, -drawH/2, drawW, drawH); ctx.restore(); }
  function drawOverlay(){ const ctx = overlay.getContext('2d'); ctx.clearRect(0,0,overlay.width, overlay.height); for (const it of editState.items){ ctx.save(); ctx.strokeStyle = it.color; ctx.fillStyle = it.color; ctx.lineWidth = it.stroke; if (it.type==='rect'){ ctx.strokeRect(it.x, it.y, it.w, it.h); } else if (it.type==='arrow'){ // simple arrow from (x,y) to (x2,y2)
        const dx=it.x2-it.x, dy=it.y2-it.y; const len=Math.hypot(dx,dy)||1; const ux=dx/len, uy=dy/len; const head=10+it.stroke*2; ctx.beginPath(); ctx.moveTo(it.x, it.y); ctx.lineTo(it.x2, it.y2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(it.x2, it.y2); ctx.lineTo(it.x2 - ux*head - uy*head*0.5, it.y2 - uy*head + ux*head*0.5); ctx.lineTo(it.x2 - ux*head + uy*head*0.5, it.y2 - uy*head - ux*head*0.5); ctx.closePath(); ctx.fill(); }
      else if (it.type==='text'){ ctx.font = it.font; ctx.fillText(it.text||'', it.x, it.y); }
      if (editState.selectedId===it.id){ ctx.setLineDash([4,3]); ctx.strokeStyle = '#3b82f6'; const bb = itemBounds(it); if (bb){ ctx.strokeRect(bb.x, bb.y, bb.w, bb.h); } }
      ctx.restore(); }
  }
  function redraw(){ drawBase(); drawOverlay(); }
  function itemAt(x,y){ for (let i=editState.items.length-1; i>=0; i--){ const it=editState.items[i]; const b=itemBounds(it); if (b && x>=b.x && y>=b.y && x<=b.x+b.w && y<=b.y+b.h) return it; } return null; }
  function itemBounds(it){ if (it.type==='rect'){ const w=Math.abs(it.w), h=Math.abs(it.h); const x=Math.min(it.x, it.x+it.w), y=Math.min(it.y, it.y+it.h); return {x,y,w,h}; } if (it.type==='arrow'){ const x=Math.min(it.x,it.x2), y=Math.min(it.y,it.y2); return {x,y,w:Math.abs(it.x2-it.x), h:Math.abs(it.y2-it.y)}; } if (it.type==='text'){ const ctx=overlay.getContext('2d'); ctx.font=it.font; const w = ctx.measureText(it.text||'').width; const h = parseInt(it.font,10) || 16; return {x:it.x, y:it.y-h, w, h}; } return null; }
  // Mode buttons
  const modePan = document.getElementById('imgEditModePan'); const modeRect = document.getElementById('imgEditModeRect'); const modeArrow = document.getElementById('imgEditModeArrow'); const modeText = document.getElementById('imgEditModeText');
  function setMode(m){ editState.mode=m; [modePan,modeRect,modeArrow,modeText].forEach(b=>b && b.classList.remove('active')); const map={pan:modePan, rect:modeRect, arrow:modeArrow, text:modeText}; if (map[m]) map[m].classList.add('active'); overlay.style.pointerEvents = (m==='pan'?'none':'auto'); }
  modePan.addEventListener('click', ()=>setMode('pan')); modeRect.addEventListener('click', ()=>setMode('rect')); modeArrow.addEventListener('click', ()=>setMode('arrow')); modeText.addEventListener('click', ()=>setMode('text'));
  document.getElementById('imgEditColor').addEventListener('input', (e)=>{ editState.color=e.target.value; });
  document.getElementById('imgEditStroke').addEventListener('input', (e)=>{ editState.stroke=parseInt(e.target.value||'3',10)||3; });
  document.getElementById('imgEditFont').addEventListener('input', (e)=>{ editState.font=e.target.value||'16px Montserrat'; });
  document.getElementById('imgEditText').addEventListener('input', (e)=>{ editState.text=e.target.value||''; });

  // Interactions
  let dragging=false, startX=0, startY=0;
  canvas.addEventListener('mousedown', (e)=>{ if (editState.mode!=='pan') return; dragging=true; startX=e.offsetX; startY=e.offsetY; });
  canvas.addEventListener('mousemove', (e)=>{ if (!dragging || editState.mode!=='pan') return; editState.offsetX += (e.offsetX-startX); editState.offsetY += (e.offsetY-startY); startX=e.offsetX; startY=e.offsetY; redraw(); });
  window.addEventListener('mouseup', ()=>{ dragging=false; });

  let drawingItem=null; // for rect/arrow
  overlay.style.pointerEvents='auto';
  overlay.addEventListener('mousedown', (e)=>{
    const x=e.offsetX, y=e.offsetY;
    if (editState.mode==='rect'){
      drawingItem = { id: 'it_'+Date.now(), type:'rect', x, y, w:1, h:1, color: editState.color, stroke: editState.stroke };
      editState.items.push(drawingItem); editState.selectedId = drawingItem.id; redraw();
    } else if (editState.mode==='arrow'){
      drawingItem = { id: 'it_'+Date.now(), type:'arrow', x, y, x2:x+1, y2:y+1, color: editState.color, stroke: editState.stroke };
      editState.items.push(drawingItem); editState.selectedId = drawingItem.id; redraw();
    } else if (editState.mode==='text'){
      const it = { id:'it_'+Date.now(), type:'text', x, y, text: editState.text, font: editState.font, color: editState.color, stroke: editState.stroke };
      editState.items.push(it); editState.selectedId = it.id; redraw();
    } else {
      // selection
      const hit = itemAt(x,y); editState.selectedId = hit ? hit.id : null; redraw();
    }
  });
  overlay.addEventListener('mousemove', (e)=>{
    if (!drawingItem) return;
    if (drawingItem.type==='rect'){ drawingItem.w = (e.offsetX - drawingItem.x); drawingItem.h = (e.offsetY - drawingItem.y); }
    if (drawingItem.type==='arrow'){ drawingItem.x2 = e.offsetX; drawingItem.y2 = e.offsetY; }
    redraw();
  });
  window.addEventListener('mouseup', ()=>{ drawingItem=null; });
  // drag selected item
  let moving=null, moveStart=null;
  overlay.addEventListener('mousedown', (e)=>{
    if (editState.mode!=='pan') return;
    const hit=itemAt(e.offsetX, e.offsetY); if (hit){ moving=hit; moveStart={x:e.offsetX, y:e.offsetY}; e.preventDefault(); }
  });
  overlay.addEventListener('mousemove', (e)=>{
    if (!moving) return;
    const dx=e.offsetX - moveStart.x, dy=e.offsetY - moveStart.y; moveStart={x:e.offsetX, y:e.offsetY};
    if (moving.type==='rect'){ moving.x+=dx; moving.y+=dy; }
    if (moving.type==='arrow'){ moving.x+=dx; moving.y+=dy; moving.x2+=dx; moving.y2+=dy; }
    if (moving.type==='text'){ moving.x+=dx; moving.y+=dy; }
    redraw();
  });
  window.addEventListener('mouseup', ()=>{ moving=null; });
  window.addEventListener('keydown', (e)=>{ if (e.key==='Delete' && editState.selectedId){ editState.items = editState.items.filter(it=>it.id!==editState.selectedId); editState.selectedId=null; redraw(); } });

  document.getElementById('imgEditRotateL').addEventListener('click', ()=>{ editState.angle = (editState.angle+270)%360; redraw(); });
  document.getElementById('imgEditRotateR').addEventListener('click', ()=>{ editState.angle = (editState.angle+90)%360; redraw(); });
  zoomEl.addEventListener('input', ()=>{ editState.scale = parseFloat(zoomEl.value||'1'); redraw(); });
  document.getElementById('imgEditReset').addEventListener('click', ()=>{ resetEditor(); redraw(); });
  document.getElementById('imgEditBack').addEventListener('click', ()=>{ editorBox.style.display='none'; document.getElementById('imgPickerGrid').style.display='grid'; });
  async function openEditor(fid, fname){ try{ // load image from download url
      const j = await fetch('/files/'+encodeURIComponent(fid)+'/download').then(x=>x.json());
      const url = j && j.download_url ? j.download_url : null; if (!url){ alert('Cannot download image'); return; }
      editState = { img:new Image(), angle:0, scale:1, offsetX:0, offsetY:0, aspect: targetAspect(), fileId: fid, fileName: fname||fid };
      editorHint.textContent = `Edit ${fname||fid} — aspect ${editState.aspect.toFixed(3)} (drag to move)`;
      await new Promise((res, rej)=>{ editState.img.crossOrigin='anonymous'; editState.img.onload=()=>res(null); editState.img.onerror=rej; editState.img.src=url; });
      setCanvasSize(); resetEditor(); drawEditor();
      document.getElementById('imgPickerGrid').style.display='none'; editorBox.style.display='block';
    }catch(e){ alert('Failed to load image'); } }
  const editBtn = document.getElementById('imgPickerEditBtn'); if (editBtn){ editBtn.addEventListener('click', ()=>{ const fid = editBtn.dataset.fileId||''; const fname = editBtn.dataset.fileName||fid; if (!fid) return; openEditor(fid, fname); }); }
  document.getElementById('imgEditApply').addEventListener('click', async ()=>{
    try{
      // Render crop to fit canvas (canvas already has target aspect)
      const blob = await new Promise(res=>canvas.toBlob(res, 'image/png'));
      if (!blob){ alert('Render failed'); return; }
      const f = new File([blob], 'edited.png', { type:'image/png' });
      const token = window.MKHubUI ? MKHubUI.getTokenOrRedirect() : localStorage.getItem('user_token');
      const upReq = { project_id: null, client_id: clientId, employee_id: null, category_id: 'site-docs', original_name: f.name, content_type: f.type };
      const up = await fetch('/files/upload', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify(upReq) }).then(x=>x.json());
      const putResp = await fetch(up.upload_url, { method:'PUT', headers:{ 'Content-Type': f.type, 'x-ms-blob-type': 'BlockBlob' }, body: f });
      if (!putResp.ok){ alert('Upload failed'); return; }
      const conf = await fetch('/files/confirm', { method:'POST', headers:{ 'Content-Type':'application/json', Authorization:'Bearer '+token }, body: JSON.stringify({ key: up.key, size_bytes: blob.size, checksum_sha256: 'na', content_type: f.type }) }).then(x=>x.json());
      await fetch(`/clients/${encodeURIComponent(clientId)}/files?file_object_id=${encodeURIComponent(conf.id)}&category=site-docs&original_name=${encodeURIComponent(f.name)}&site_id=${encodeURIComponent(siteId||'')}`, { method:'POST', headers:{ Authorization:'Bearer '+token } });
      // Select new file id
      const selBtn = document.getElementById('imgPickerSelect'); selBtn.dataset.fileId = conf.id; selBtn.dataset.fileName = f.name; document.getElementById('imgPickerGrid').style.display='grid'; editorBox.style.display='none'; await choosePic(modal.dataset.target||'cover');
    }catch(e){ alert('Apply failed'); }
  });

  // Expose picker for section images
  window.MK_OpenImagePickerForSection = async function(sectionEl){
    try{
      const dataId = sectionEl?.getAttribute('data-section-id') || sectionEl?.dataset?.sectionId || '';
      let secId = dataId || sectionEl?.id || '';
      if (!secId){ secId = 'section_' + Math.random().toString(36).slice(2); }
      // Always assign the element id so the modal can resolve it later
      sectionEl.id = secId;
      await choosePic(secId);
    }catch(e){}
  }

  // Save proposal (create or update)
  const saveBtn = document.getElementById('saveProposalBtn');
  if (saveBtn){
    saveBtn.addEventListener('click', async ()=>{
      try{
        const qp2 = new URLSearchParams(location.search);
        const existingId = qp2.get('draft_id') || null;
        const payload = collectDraft();
        payload.client_id = clientId || null;
        payload.site_id = siteId || null;
        payload.project_id = projectId || null;
        payload.order_number = document.getElementById('order_number')?.value || null;
        payload.cover_title = document.querySelector('[name="cover_title"]')?.value || 'Proposal';
        if (existingId) payload.id = existingId;
        const r = await fetch('/proposals', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const j = await r.json();
        if (r.ok && j && j.id){
          const msg = document.getElementById('msg'); if (msg) msg.textContent = 'Saved.';
          history.replaceState(null, '', `${location.pathname}?draft_id=${encodeURIComponent(j.id)}${clientId?`&client_id=${encodeURIComponent(clientId)}`:''}${siteId?`&site_id=${encodeURIComponent(siteId)}`:''}`);
        } else {
          alert('Save failed: ' + (j && j.detail ? j.detail : 'unknown'));
        }
      }catch(e){ alert('Save failed'); }
    });
  }
});
</script>
