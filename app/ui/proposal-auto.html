<!doctype html>
<meta charset="utf-8">
<title>Auto Proposal</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2>Create Proposal (Auto)</h2>
  <div id="info" class="card"></div>
  <div class="card">
    <form id="proposalForm" enctype="multipart/form-data">
      <input type="hidden" id="client_id" />
      <input type="hidden" id="site_id" />
      <input type="hidden" id="proposal_created_for" name="proposal_created_for" />
      <h3>Company Info</h3>
      <div class="field"><label>Document Type</label><input type="text" name="cover_title" maxlength="22" required></div>
      <div class="field"><label>Order Number</label><input type="text" id="order_number" name="order_number" maxlength="20" required readonly></div>
      <div class="field"><label>Company Name</label><input type="text" id="company_name" name="company_name" maxlength="50" required readonly></div>
      <div class="field"><label>Company Address</label><input type="text" id="company_address" name="company_address" maxlength="50" required readonly></div>
      <div class="field"><label>Date</label><input type="date" id="date" name="date" required></div>

      <h3>Project Details</h3>
      <div class="field"><label>Proposal Created For</label>
        <select id="contact_sel_for"></select>
      </div>
      <div class="field"><label>Primary Contact</label>
        <select id="contact_sel_primary"></select>
      </div>
      <div class="field"><label>Primary Contact Name</label><input type="text" id="contact_name" name="primary_contact_name" maxlength="40" readonly></div>
      <div class="field"><label>Primary Contact Phone</label><input type="text" id="contact_phone" name="primary_contact_phone" maxlength="15" readonly></div>
      <div class="field"><label>Primary Contact Email</label><input type="email" id="contact_email" name="primary_contact_email" maxlength="40" readonly></div>
      <div class="field"><label>Type of Project</label><input type="text" name="type_of_project" maxlength="55"></div>
      <div class="field"><label>Other Notes</label><textarea name="other_notes" maxlength="260"></textarea></div>

      <h3>Images</h3>
      <div class="field"><label>Cover Image</label>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
          <input type="file" name="cover_image" accept="image/*">
          <input type="hidden" id="cover_file_object_id" name="cover_file_object_id" />
          <button type="button" id="chooseCoverFromPics">Choose from Customer Pictures</button>
          <span id="coverPickInfo" class="muted"></span>
        </div>
      </div>
      <div class="field"><label>Page 2 Image</label>
        <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
          <input type="file" name="page2_image" accept="image/*">
          <input type="hidden" id="page2_file_object_id" name="page2_file_object_id" />
          <button type="button" id="choosePage2FromPics">Choose from Customer Pictures</button>
          <span id="page2PickInfo" class="muted"></span>
        </div>
      </div>

      <h3>Project Sections</h3>
      <div id="sectionsContainer"></div>
      <button type="button" id="addSectionBtn">+ Add Section</button>

      <h3>Pricing</h3>
      <div class="field"><label>Bid Price</label><input type="number" step="0.01" name="bid_price" required></div>
      <div id="additionalCostsSection">
        <h4>Additional Costs</h4>
        <div id="costsContainer"></div>
        <button type="button" id="addCostBtn">+ Add Cost</button>
      </div>
      <h4>Total: <span id="calculatedTotal">$0.00</span></h4>

      <h3>Terms</h3>
      <div class="field"><label>Terms</label><textarea name="terms_text"></textarea></div>

      <div class="row" style="justify-content:space-between; align-items:center; gap:8px">
        <div>
          <button type="button" id="saveProposalBtn">Save Proposal</button>
        </div>
        <div>
          <button type="submit">Generate Proposal</button>
        </div>
      </div>
    </form>
    <pre id="msg" class="muted"></pre>
  </div>
  <div id="downloadSection" class="card" style="display:none;">
    <h3>Proposal Generated</h3>
    <a id="downloadLink" href="#" download="ProjectProposal.pdf">Download PDF</a>
  </div>
</div>
<script src="/ui/proposals.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Sidebar init with fallback if MKHubUI not present yet
  try{
    if (window.MKHubUI && typeof MKHubUI.initSidebar === 'function') {
      MKHubUI.initSidebar('home');
    } else {
      const mount = document.getElementById('sidebar');
      if (mount) {
        const html = await fetch('/ui/sidebar.html?v=' + Date.now()).then(r=>r.text()).catch(()=>null);
        if (html) mount.outerHTML = html;
      }
    }
  }catch(e){}

  const qp = new URLSearchParams(location.search);
  const clientId = qp.get('client_id') || '';
  const siteId = qp.get('site_id') || '';
  const clientHidden = document.getElementById('client_id'); if (clientHidden) clientHidden.value = clientId;
  const siteHidden = document.getElementById('site_id'); if (siteHidden) siteHidden.value = siteId;

  async function initPrefill(){
    try{
      const token = window.MKHubUI ? MKHubUI.getTokenOrRedirect() : localStorage.getItem('user_token');
      if (!clientId){ throw new Error('missing client'); }
      const cust = await fetch('/clients/'+clientId, { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json());
      const sites = await fetch('/clients/'+clientId+'/sites', { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json());
      const site = (sites||[]).find(s=>s.id===siteId) || null;
      const nameEl = document.getElementById('company_name'); if (nameEl) nameEl.value = (cust.display_name || cust.name || '').slice(0,50);
      const addr = site ? [site.site_address_line1, site.site_city, site.site_province, site.site_country].filter(Boolean).join(', ') : [cust.address_line1, cust.city, cust.province, cust.country].filter(Boolean).join(', ');
      const addrEl = document.getElementById('company_address'); if (addrEl) addrEl.value = addr.slice(0,50);
      // preset today's date
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      const dateEl = document.getElementById('date'); if (dateEl) dateEl.value = `${yyyy}-${mm}-${dd}`;
      try{
        const code = await fetch('/proposals/next-code?client_id='+encodeURIComponent(clientId)).then(x=>x.json());
        if (code && code.order_number){ const on = document.getElementById('order_number'); if (on) on.value = code.order_number; }
      }catch(e){}
      const contacts = await fetch('/clients/'+clientId+'/contacts', { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json()).catch(()=>[]);
      const selFor = document.getElementById('contact_sel_for');
      const selPrimary = document.getElementById('contact_sel_primary');
      const optsHtml = '<option value="">Select...</option>' + (contacts||[]).map(c=>`<option value="${c.id}" data-email="${c.email||''}" data-phone="${c.phone||''}" data-name="${c.name||''}" data-primary="${c.is_primary?'1':'0'}">${c.name||c.email||c.phone||c.id}</option>`).join('');
      if (selFor){ selFor.innerHTML = optsHtml; }
      if (selPrimary){ selPrimary.innerHTML = optsHtml; }
      function syncPrimaryDetails(){
        if (!selPrimary) return;
        const o = selPrimary.options[selPrimary.selectedIndex] || {};
          const nm = o.getAttribute ? (o.getAttribute('data-name')||'') : '';
          const setVal=(id,v)=>{ const el=document.getElementById(id); if (el) el.value=v; };
          setVal('contact_name', nm);
          setVal('contact_phone', o.getAttribute ? (o.getAttribute('data-phone')||'') : '');
          setVal('contact_email', o.getAttribute ? (o.getAttribute('data-email')||'') : '');
      }
      if (selFor){ selFor.addEventListener('change', ()=>{
        const o = selFor.options[selFor.selectedIndex] || {};
        const nm = o.getAttribute ? (o.getAttribute('data-name')||'') : '';
        const hidden = document.getElementById('proposal_created_for'); if (hidden) hidden.value = nm;
      }); }
      if (selPrimary){ selPrimary.addEventListener('change', syncPrimaryDetails); }
      // preselect primary contact in Primary dropdown; do not force in Created For
      if (selPrimary){ const primaryOpt = Array.from(selPrimary.options||[]).find(o=>o.getAttribute && o.getAttribute('data-primary')==='1'); if (primaryOpt){ selPrimary.value = primaryOpt.value; syncPrimaryDetails(); } }
      const info = document.getElementById('info');
      if (info){ info.innerHTML = `<strong>${cust.display_name || cust.name}</strong>${cust.code?` <span class=muted>(${cust.code})</span>`:''}` + (site?`<div class=muted>Site: ${(site.site_name||site.site_address_line1||'')}</div>`:''); }
    }catch(e){ const msg=document.getElementById('msg'); if (msg) msg.textContent = 'Prefill failed. Please ensure you opened from a site or are logged in.'; }
  }
  initPrefill();

  // Choose cover/page2 from customer pictures
  async function choosePic(target){
    try{
      if (!clientId){ alert('Missing customer'); return; }
      const token = window.MKHubUI ? MKHubUI.getTokenOrRedirect() : localStorage.getItem('user_token');
      const url = '/clients/'+encodeURIComponent(clientId)+'/files' + (siteId? ('?site_id='+encodeURIComponent(siteId)) : '');
      const arr = await fetch(url, { headers: token? { Authorization:'Bearer '+token } : {} }).then(x=>x.json());
      const pics = (arr||[]).filter(f=> (f.is_image===true) || String(f.content_type||'').startsWith('image/'));
      if (!pics.length){ alert('No pictures found for this customer'); return; }
      const names = pics.map((f,i)=>`${i+1}. ${f.original_name || f.key || f.file_object_id}`).join('\n');
      const pick = prompt(`Choose image number:\n${names}`);
      const idx = parseInt(pick||'',10)-1; if (!(idx>=0 && idx<pics.length)) return;
      const chosen = pics[idx];
      if (target==='cover'){
        const hid = document.getElementById('cover_file_object_id'); if (hid) hid.value = chosen.file_object_id;
        const info = document.getElementById('coverPickInfo'); if (info) info.textContent = (chosen.original_name||chosen.key||chosen.file_object_id);
        const fi = document.querySelector('input[name="cover_image"]'); if (fi) fi.value = '';
      } else {
        const hid = document.getElementById('page2_file_object_id'); if (hid) hid.value = chosen.file_object_id;
        const info = document.getElementById('page2PickInfo'); if (info) info.textContent = (chosen.original_name||chosen.key||chosen.file_object_id);
        const fi = document.querySelector('input[name="page2_image"]'); if (fi) fi.value = '';
      }
    }catch(e){}
  }
  const btnCover = document.getElementById('chooseCoverFromPics'); if (btnCover){ btnCover.addEventListener('click', ()=>choosePic('cover')); }
  const btnPage2 = document.getElementById('choosePage2FromPics'); if (btnPage2){ btnPage2.addEventListener('click', ()=>choosePic('page2')); }

  // Save proposal (create or update)
  const saveBtn = document.getElementById('saveProposalBtn');
  if (saveBtn){
    saveBtn.addEventListener('click', async ()=>{
      try{
        const qp2 = new URLSearchParams(location.search);
        const existingId = qp2.get('draft_id') || null;
        const payload = collectDraft();
        payload.client_id = clientId || null;
        payload.site_id = siteId || null;
        payload.order_number = document.getElementById('order_number')?.value || null;
        payload.cover_title = document.querySelector('[name="cover_title"]')?.value || 'Proposal';
        if (existingId) payload.id = existingId;
        const r = await fetch('/proposals', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const j = await r.json();
        if (r.ok && j && j.id){
          const msg = document.getElementById('msg'); if (msg) msg.textContent = 'Saved.';
          history.replaceState(null, '', `${location.pathname}?draft_id=${encodeURIComponent(j.id)}${clientId?`&client_id=${encodeURIComponent(clientId)}`:''}${siteId?`&site_id=${encodeURIComponent(siteId)}`:''}`);
        } else {
          alert('Save failed: ' + (j && j.detail ? j.detail : 'unknown'));
        }
      }catch(e){ alert('Save failed'); }
    });
  }
});
</script>
