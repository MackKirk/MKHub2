<!doctype html>
<meta charset="utf-8">
<title>Settings List</title>
<link rel="stylesheet" href="/ui/styles.css">
<script src="/ui/app.js"></script>
<div id="sidebar"></div>
<div class="main">
  <h2 id="title">Settings</h2>
  <div class="card">
    <div class="row">
      <div class="field"><label>Label</label><input id="itemLabel" /></div>
      <div class="field"><label>Description</label><input id="itemValue" /></div>
      <div class="field" style="align-self:end"><button id="addItem">Add</button></div>
    </div>
    <div id="items" class="card"></div>
    <a class="btn" href="/ui/settings.html">Back to Settings</a>
  </div>
</div>
<script>
MKHubUI.initSidebar('settings');
function auth(){ return { Authorization:'Bearer '+MKHubUI.getTokenOrRedirect() }; }
const params = new URLSearchParams(location.search);
const list = params.get('list') || 'client_types';
document.getElementById('title').textContent = `List: ${list}`;
async function refresh(){
  const arr = await fetch('/settings/'+list, { headers: auth() }).then(x=>x.json());
  window._items = Array.isArray(arr) ? arr.slice() : [];
  renderList();
}
document.getElementById('addItem').addEventListener('click', async ()=>{
  const label = document.getElementById('itemLabel').value.trim();
  const value = document.getElementById('itemValue').value.trim();
  if (!label) return;
  await fetch(`/settings/${list}?label=${encodeURIComponent(label)}&value=${encodeURIComponent(value)}&sort_index=0`, { method:'POST', headers: auth() });
  document.getElementById('itemLabel').value=''; document.getElementById('itemValue').value='';
  refresh();
});
window.delItem = async function(id){ await fetch(`/settings/${list}/${id}`, { method:'DELETE', headers: auth() }); refresh(); };
window.editItem = async function(id){
  const it = (window._items||[]).find(x=>x.id===id);
  if (!it) return;
  const newLabel = prompt('Label', it.label || '') ?? it.label;
  if (newLabel === null) return;
  const newDesc = prompt('Description', it.value || '') ?? it.value;
  const qp = new URLSearchParams();
  qp.set('label', newLabel);
  qp.set('value', newDesc||'');
  await fetch(`/settings/${list}/${id}?`+qp.toString(), { method:'PUT', headers: auth() });
  refresh();
};
window.moveUp = function(id){ reorder(id, -1); };
window.moveDown = function(id){ reorder(id, 1); };
function renderList(){
  const el = document.getElementById('items');
  const arr = window._items || [];
  if (!arr.length){ el.textContent = 'No items'; return; }
  el.innerHTML = arr.map(i=>
    `<div class="dr" draggable="true" data-id="${i.id}" style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0;gap:10px">`
    + `<div style="flex:1"><strong>${i.label}</strong>${i.value?` <span class=muted>(${i.value})</span>`:''}</div>`
    + `<div style="display:flex;gap:6px">`
      + `<button onclick="moveUp('${i.id}')">↑</button>`
      + `<button onclick="moveDown('${i.id}')">↓</button>`
      + `<button onclick="editItem('${i.id}')">Edit</button>`
      + `<button onclick="delItem('${i.id}')">Delete</button>`
    + `</div>`
    + `</div>`
  ).join('');
  enableDnD();
}
function enableDnD(){
  const rows = Array.from(document.querySelectorAll('.dr'));
  let dragId = null;
  rows.forEach(r=>{
    r.addEventListener('dragstart', (e)=>{ dragId = r.getAttribute('data-id'); e.dataTransfer.setData('text/plain', dragId); });
    r.addEventListener('dragover', (e)=>{ e.preventDefault(); r.style.background='#f7f7f7'; });
    r.addEventListener('dragleave', ()=>{ r.style.background=''; });
    r.addEventListener('drop', (e)=>{ e.preventDefault(); r.style.background=''; const targetId=r.getAttribute('data-id'); if (!dragId || dragId===targetId) return; reorderBetween(dragId, targetId); dragId=null; });
  });
}
function reorder(id, delta){
  const arr = window._items || [];
  const idx = arr.findIndex(x=>x.id===id); if (idx<0) return;
  const j = idx + delta; if (j<0 || j>=arr.length) return;
  const tmp = arr[idx]; arr[idx] = arr[j]; arr[j] = tmp;
  persistOrder(arr);
}
function reorderBetween(srcId, dstId){
  const arr = window._items || [];
  const si = arr.findIndex(x=>x.id===srcId); const di = arr.findIndex(x=>x.id===dstId);
  if (si<0 || di<0) return;
  const [m] = arr.splice(si,1);
  arr.splice(di,0,m);
  persistOrder(arr);
}
async function persistOrder(arr){
  const updates = arr.map((it, idx)=>({ id: it.id, sort: (idx+1)*10 }));
  window._items = arr.map((it, idx)=>({ ...it, sort_index: updates[idx].sort }));
  renderList();
  for (const u of updates){
    const qp = new URLSearchParams(); qp.set('sort_index', String(u.sort));
    try { await fetch(`/settings/${list}/${u.id}?`+qp.toString(), { method:'PUT', headers: auth() }); } catch(e){}
  }
  refresh();
}
refresh();
</script>
