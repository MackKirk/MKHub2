<div class="side">
  <h3>MK Hub</h3>
  <div id="hello" class="muted"></div>
  <a href="/ui/home.html" id="nav-home">Home</a>
  <a href="/ui/profile.html" id="nav-profile">My Information</a>
  <a href="/ui/invite.html" id="nav-invite" data-perm="invite:send" style="display:none">Invite Users</a>
  <a href="/ui/users.html" id="nav-users" data-perm="users:read" style="display:none">Users</a>
  <div class="muted" style="margin-top:10px">Inventory</div>
  <a href="/ui/inventory-suppliers.html" id="nav-inventory-suppliers" data-perm="inventory:read" style="display:none;padding-left:12px">Suppliers</a>
  <a href="/ui/inventory-products.html" id="nav-inventory-products" data-perm="inventory:read" style="display:none;padding-left:12px">Products</a>
  <a href="/ui/inventory-orders.html" id="nav-inventory-orders" data-perm="inventory:read" style="display:none;padding-left:12px">Orders</a>
  <div class="muted" style="margin-top:10px">Customers</div>
  <a href="/ui/customers.html" id="nav-customers" data-perm="clients:read" style="display:none;padding-left:12px">All Customers</a>
  <a href="/ui/customer-new.html" id="nav-customer-new" data-perm="clients:write" style="display:none;padding-left:12px">New Customer</a>
  <a href="/ui/proposals.html" id="nav-proposals" data-perm="clients:read" style="display:none;padding-left:12px">Proposals</a>
  <div class="muted" style="margin-top:10px">Settings</div>
  <a href="/ui/settings.html" id="nav-settings" data-perm="users:write" style="display:none;padding-left:12px">System Settings</a>
  <button onclick="logout()">Logout</button>
</div>
<script>
function logout(){ localStorage.removeItem('user_token'); location.href='/ui/login.html'; }
const token = localStorage.getItem('user_token');
if(!token){ location.href='/ui/login.html'; }
fetch('/auth/me', { headers:{ Authorization:'Bearer '+token } })
  .then(r => { if (r.status === 401) { localStorage.removeItem('user_token'); location.href='/ui/login.html'; return null; } return r ? r.json() : null; })
  .then(u => {
    if (!u) return;
    const el=document.getElementById('hello'); if(el){ el.textContent = 'Hello, ' + (u.username || 'user'); }
    const roles = (u.roles||[]).map(r => (r||'').toLowerCase());
    const isAdmin = roles.includes('admin');
    const perms = new Set((u.permissions||[]));
    document.querySelectorAll('.side a[data-perm]').forEach(a => {
      const need = a.getAttribute('data-perm');
      const hasAlt = need === 'users:read' && perms.has('users:write');
      if (isAdmin || (need && (perms.has(need) || hasAlt))) { a.style.display = 'block'; }
    });
  });
const path = location.pathname;
for (const id of ['home','profile','invite','users','inventory-suppliers','inventory-products','inventory-orders','customers','customer-new','proposals','settings']) {
  const el = document.getElementById('nav-'+id);
  if (el && path.endsWith(id+'.html')) { el.classList.add('active'); }
}
</script>

